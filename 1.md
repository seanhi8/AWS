# âœ… AWSãƒªã‚½ãƒ¼ã‚¹ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆprodç’°å¢ƒç”¨ï¼‰

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€**prodç’°å¢ƒ**ã«ãŠã‘ã‚‹å„AWSãƒªã‚½ãƒ¼ã‚¹ã®ã€Œæ§‹ç¯‰å‰ç¢ºèªç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã€ã¨ã€ãã‚Œã«å¯¾å¿œã™ã‚‹ **AWS CDKï¼ˆTypeScriptï¼‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ** ã‚’è¨˜è¼‰ã—ãŸã‚‚ã®ã§ã™ã€‚

---

## 1. API Gatewayï¼ˆHTTP APIï¼‰

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§

| é …ç›®         | å€¤                                 |
| ---------- | --------------------------------- |
| APIç¨®åˆ¥      | HTTP API                          |
| ç‰©ç†å        | `myapp-api-public-prod`           |
| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚¿ã‚¤ãƒ— | Regional                          |
| èªè¨¼æ–¹å¼       | JWT Authorizerï¼ˆCognito User Poolï¼‰ |
| CORSè¨­å®š     | æœ‰åŠ¹ï¼ˆ`*`, GET/POST/OPTIONSï¼‰         |
| çµ±åˆå¯¾è±¡       | Lambdaï¼ˆAWS\_PROXYï¼‰                |
| ã‚¹ãƒ†ãƒ¼ã‚¸å      | `$default`ï¼ˆè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰                |
| ãƒ­ã‚°å‡ºåŠ›       | CloudWatch Logs æœ‰åŠ¹                |
| ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°    | ç„¡åŠ¹                                |
| ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡     | WAFã§åˆ¶å¾¡                            |

### CDKä¾‹ï¼ˆTypeScriptï¼‰

```ts
const httpApi = new HttpApi(this, 'HttpApi', {
  apiName: 'myapp-api-public-prod',
  corsPreflight: {
    allowHeaders: ['*'],
    allowMethods: [CorsHttpMethod.GET, CorsHttpMethod.POST, CorsHttpMethod.OPTIONS],
    allowOrigins: ['*'],
  },
  defaultAuthorizer: new HttpJwtAuthorizer('JwtAuth', '<user-pool-domain>', {
    jwtAudience: ['<audience>'],
    jwtIssuer: 'https://cognito-idp.<region>.amazonaws.com/<userPoolId>'
  }),
  createDefaultStage: true,
  defaultIntegration: new HttpLambdaIntegration('LambdaIntegration', lambdaFn),
});
```

---

## 2. Lambdaï¼ˆæ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§

| é …ç›®      | å€¤                                    |
| ------- | ------------------------------------ |
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ    | Python 3.12                          |
| ãƒ¡ãƒ¢ãƒª     | 512 MB                               |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ  | 10 ç§’                                 |
| ãƒãƒ³ãƒ‰ãƒ©ãƒ¼   | `main.handler`                       |
| ç’°å¢ƒå¤‰æ•°    | DYNAMODB\_TABLE=myapp-ddb-users-prod |
| å®Ÿè¡Œãƒ­ãƒ¼ãƒ«   | `myapp-role-lambda-exec-prod`        |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚° | æœ‰åŠ¹                                   |
| DLQ     | æœ‰åŠ¹ï¼ˆSQSï¼‰                              |

### CDKä¾‹ï¼ˆTypeScriptï¼‰

```ts
const lambdaFn = new Function(this, 'ApiLambdaFn', {
  runtime: Runtime.PYTHON_3_12,
  handler: 'main.handler',
  code: Code.fromBucket(s3Bucket, 'lambda/api.zip'),
  memorySize: 512,
  timeout: Duration.seconds(10),
  environment: {
    DYNAMODB_TABLE: 'myapp-ddb-users-prod'
  },
  deadLetterQueueEnabled: true,
  deadLetterQueue: new Queue(this, 'LambdaDLQ'),
});
```

---

## 3. DynamoDBï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§

| é …ç›®        | å€¤                      |
| --------- | ---------------------- |
| ãƒ†ãƒ¼ãƒ–ãƒ«å     | `myapp-ddb-users-prod` |
| ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ | `userId`ï¼ˆStringï¼‰       |
| ã‚½ãƒ¼ãƒˆã‚­ãƒ¼     | `timestamp`ï¼ˆNumberï¼‰    |
| å®¹é‡ãƒ¢ãƒ¼ãƒ‰     | ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰                 |
| PITR      | æœ‰åŠ¹                     |
| TTLå±æ€§     | `ttl`ï¼ˆNumberï¼‰          |
| æš—å·åŒ–       | AWSç®¡ç†ã‚­ãƒ¼                |

### CDKä¾‹ï¼ˆTypeScriptï¼‰

```ts
const userTable = new Table(this, 'UserTable', {
  tableName: 'myapp-ddb-users-prod',
  partitionKey: { name: 'userId', type: AttributeType.STRING },
  sortKey: { name: 'timestamp', type: AttributeType.NUMBER },
  billingMode: BillingMode.PAY_PER_REQUEST,
  pointInTimeRecovery: true,
  timeToLiveAttribute: 'ttl',
});
```

---

## 4. S3 ãƒã‚±ãƒƒãƒˆï¼ˆLambdaã‚³ãƒ¼ãƒ‰ã€é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

### Lambdaã‚³ãƒ¼ãƒ‰ç”¨ãƒã‚±ãƒƒãƒˆ

| é …ç›®      | å€¤                               |
| ------- | ------------------------------- |
| ãƒã‚±ãƒƒãƒˆå   | `myapp-lambda-code-bucket-prod` |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚° | æœ‰åŠ¹                              |
| æš—å·åŒ–     | SSE-S3                          |

### é™çš„ã‚¢ã‚»ãƒƒãƒˆç”¨ãƒã‚±ãƒƒãƒˆ

| é …ç›®       | å€¤                                   |
| -------- | ----------------------------------- |
| ãƒã‚±ãƒƒãƒˆå    | `myapp-frontend-assets-bucket-prod` |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°  | æœ‰åŠ¹                                  |
| æš—å·åŒ–      | SSE-S3                              |
| é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚° | ç„¡åŠ¹ï¼ˆCloudFronté…ä¿¡ï¼‰                    |

### CDKä¾‹ï¼ˆTypeScriptï¼‰

```ts
const lambdaCodeBucket = new Bucket(this, 'LambdaCodeBucket', {
  bucketName: 'myapp-lambda-code-bucket-prod',
  versioned: true,
  encryption: BucketEncryption.S3_MANAGED,
});
```

---

## 5. CloudFrontï¼ˆç®¡ç†ç”»é¢ï¼‰

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§

| é …ç›®           | å€¤                                   |
| ------------ | ----------------------------------- |
| ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³å | `myapp-cf-prod`                     |
| ã‚ªãƒªã‚¸ãƒ³         | `myapp-frontend-assets-bucket-prod` |
| WAF          | `myapp-waf-webacl-prod`             |
| ãƒ­ã‚°å‡ºåŠ›         | æœ‰åŠ¹                                  |

### CDKä¾‹ï¼ˆTypeScriptï¼‰

```ts
const distribution = new Distribution(this, 'FrontendDist', {
  defaultBehavior: {
    origin: new S3Origin(frontendBucket),
    cachePolicy: CachePolicy.CACHING_OPTIMIZED,
  },
  webAclId: wafWebAcl.attrArn,
});
```

---

## 6. WAFï¼ˆCloudFrontç”¨ï¼‰

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§

| é …ç›®        | å€¤                               |
| --------- | ------------------------------- |
| åç§°        | `myapp-waf-webacl-prod`         |
| ã‚¿ã‚¤ãƒ—       | CLOUDFRONT                      |
| ç®¡ç†ãƒ«ãƒ¼ãƒ«     | AWSManagedRulesCommonRuleSet ãªã© |
| Geo Match | æ—¥æœ¬ã®ã¿è¨±å¯                          |

---

## 7. SNSï¼ˆã‚¢ãƒ©ãƒ¼ãƒ é€šçŸ¥ï¼‰

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§

| é …ç›®    | å€¤                      |
| ----- | ---------------------- |
| ãƒˆãƒ”ãƒƒã‚¯å | `myapp-sns-alarm-prod` |
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | Email, Slack (Webhook) |
| æš—å·åŒ–   | æœ‰åŠ¹                     |

### CDKä¾‹ï¼ˆTypeScriptï¼‰

```ts
const topic = new Topic(this, 'AlarmTopic', {
  topicName: 'myapp-sns-alarm-prod',
  displayName: 'App Alarm Topic',
});
```

---

## 8. CloudWatchï¼ˆãƒ­ã‚°ãƒ»ã‚¢ãƒ©ãƒ¼ãƒ ï¼‰

### æ¦‚è¦

| å¯¾è±¡          | è¨­å®š                          |
| ----------- | --------------------------- |
| Lambda      | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã€Durationç›£è¦–ã€ãƒ­ã‚°ä¿å­˜90æ—¥ |
| API Gateway | 5XXã‚¨ãƒ©ãƒ¼ç›£è¦–ã€ãƒ­ã‚°ä¿å­˜90æ—¥            |
| DynamoDB    | ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚¨ãƒ©ãƒ¼ç›£è¦–                 |

---

## 9. EventBridgeï¼ˆS3ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§

| é …ç›®      | å€¤                            |
| ------- | ---------------------------- |
| åå‰      | `myapp-event-s3-upload-prod` |
| ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ | S3\:ObjectCreated\:Put       |
| ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ   | Lambdaè‡ªå‹•æ›´æ–°å‡¦ç†                 |

### CDKä¾‹ï¼ˆTypeScriptï¼‰

```ts
new Rule(this, 'S3UploadRule', {
  eventPattern: {
    source: ['aws.s3'],
    detailType: ['Object Created'],
  },
  targets: [new LambdaFunction(lambdaFn)],
});
```

DynamoDB ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°ï¼ˆprodç’°å¢ƒï¼‰
ğŸ”· åŸºæœ¬æƒ…å ±
é …ç›®	è¨­å®šå€¤	èª¬æ˜
ãƒ†ãƒ¼ãƒ–ãƒ«å	myapp-ddb-users-prod	prodç’°å¢ƒç”¨ã®æ˜ç¢ºãªå‘½å
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³	ap-northeast-1	æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼	pkï¼ˆæ–‡å­—åˆ—å‹ï¼‰	ä¾‹ï¼šUSER#<user_id>
ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ï¼ˆRangeKeyï¼‰	skï¼ˆæ–‡å­—åˆ—å‹ï¼‰	ä¾‹ï¼šPROFILEã€SESSION#<session_id> ç­‰
ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«	å˜ä¸€ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆï¼ˆSingle Table Designï¼‰	ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãã®é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€å…ƒç®¡ç†

ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
é …ç›®	è¨­å®šå€¤	è£œè¶³
æš—å·åŒ–	æœ‰åŠ¹ï¼ˆAWSç®¡ç†ã‚­ãƒ¼ï¼šaws/dynamodbï¼‰	ã‚«ã‚¹ã‚¿ãƒ KMSã‚­ãƒ¼åˆ©ç”¨ã‚‚å¯
IAMãƒãƒªã‚·ãƒ¼åˆ¶å¾¡	æœ€å°æ¨©é™åŸå‰‡	Lambdaç­‰ã«dynamodb:GetItem, PutItemç­‰ã‚’é™å®šä»˜ä¸
ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡	VPC EndpointçµŒç”±ã‚¢ã‚¯ã‚»ã‚¹æ¨å¥¨	ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™å¯
ã‚¹ãƒˆãƒªãƒ¼ãƒ è¨­å®š	æœ‰åŠ¹ï¼ˆNEW_AND_OLD_IMAGESï¼‰	Lambdaé€£æºå¯èƒ½ã€å¤‰æ›´å±¥æ­´ç”¨

â™»ï¸ ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« & ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
é …ç›®	è¨­å®šå€¤	èª¬æ˜
ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰	ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ï¼ˆPAY_PER_REQUESTï¼‰	åˆæœŸã‚¢ã‚¯ã‚»ã‚¹æ•°ãŒä¸å®šãªãŸã‚
Auto Scaling	ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã®ãŸã‚ä¸è¦	å¿…è¦ãªã‚‰ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ³ï¼‹ASã‚‚å¯
TTLè¨­å®š	å±æ€§åï¼šttlï¼ˆUNIX timestampï¼‰	å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³è‡ªå‹•å‰Šé™¤
ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆPITRï¼‰	æœ‰åŠ¹ï¼ˆPoint-In-Time Recoveryï¼‰	âœ…
ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°	ä¸å¯ï¼ˆDynamoDBä»•æ§˜ï¼‰	

ğŸ“‹ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆï¼ˆGSIï¼‰
é …ç›®	è¨­å®šå€¤	è£œè¶³
GSIå	GSI1	ä¾‹ï¼šãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œç´¢
GSIãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼	gsi1pkï¼ˆæ–‡å­—åˆ—å‹ï¼‰	ä¾‹ï¼šEMAIL#<email>
GSIã‚½ãƒ¼ãƒˆã‚­ãƒ¼	gsi1skï¼ˆæ–‡å­—åˆ—å‹ï¼‰	ä¾‹ï¼šPROFILE
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³	ALL	å¿…è¦ã«å¿œã˜ã¦INCLUDEã«å¤‰æ›´å¯
èª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿å®¹é‡	ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰	GSIã«ã‚‚é©ç”¨ã•ã‚Œã‚‹

ğŸ“¦ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆSingle Tableï¼‰
pk	sk	å†…å®¹ä¾‹
USER#abc123	PROFILE	ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±
USER#abc123	SESSION#sess456	ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
USER#abc123	ORDER#order789	æ³¨æ–‡å±¥æ­´ï¼ˆç´ä»˜ãï¼‰
EMAIL#test@example.com	PROFILE	ãƒ¡ãƒ¼ãƒ«â†’ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ç”¨GSI

ğŸ“ˆ CloudWatch ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–è¨­å®šï¼ˆä¾‹ï¼‰
ã‚¢ãƒ©ãƒ¼ãƒ å	æ¡ä»¶	é€šçŸ¥å…ˆ
DynamoDB-ReadThrottleAlarm	ReadThrottleEvents > 0ï¼ˆ5åˆ†ï¼‰	SNS
DynamoDB-WriteThrottleAlarm	WriteThrottleEvents > 0ï¼ˆ5åˆ†ï¼‰	SNS
DynamoDB-ConsumedRead	ReadCapacityUtilization > 80%	SNS
DynamoDB-PITR-Status	PointInTimeRecoveryStatus != ENABLED	SNSï¼ˆæ§‹ç¯‰ç›´å¾Œç¢ºèªç”¨ï¼‰

ğŸ› ï¸ CDKæ§‹æˆä¾‹ï¼ˆTypeScriptï¼‰
ts
å¤åˆ¶
ç¼–è¾‘
new dynamodb.Table(this, 'UsersTable', {
  tableName: 'myapp-ddb-users-prod',
  partitionKey: { name: 'pk', type: dynamodb.AttributeType.STRING },
  sortKey: { name: 'sk', type: dynamodb.AttributeType.STRING },
  billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
  pointInTimeRecovery: true,
  removalPolicy: RemovalPolicy.RETAIN,
  encryption: dynamodb.TableEncryption.AWS_MANAGED,
  stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
  timeToLiveAttribute: 'ttl',
});
ts
å¤åˆ¶
ç¼–è¾‘
table.addGlobalSecondaryIndex({
  indexName: 'GSI1',
  partitionKey: { name: 'gsi1pk', type: dynamodb.AttributeType.STRING },
  sortKey: { name: 'gsi1sk', type: dynamodb.AttributeType.STRING },
  projectionType: dynamodb.ProjectionType.ALL,
});


API Gatewayï¼ˆHTTP APIï¼‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°ï¼ˆprodç’°å¢ƒï¼‰
é …ç›®	è¨­å®šå€¤
åç§°	myapp-api-public-prod
ã‚¿ã‚¤ãƒ—	HTTP APIï¼ˆv2ï¼‰
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚¿ã‚¤ãƒ—	Regional
çµ±åˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ	AWS Lambdaï¼ˆmyapp-lambda-api-handler-prodï¼‰
çµ±åˆã‚¿ã‚¤ãƒ—	AWS_PROXYï¼ˆLambda Proxyçµ±åˆï¼‰
èªè¨¼æ–¹å¼	IAMãƒ™ãƒ¼ã‚¹ï¼ˆsigv4ï¼‰èªè¨¼ã€å¿…è¦ã«å¿œã˜ã¦JWTï¼ˆCognitoï¼‰èªè¨¼ã¨ä½µç”¨å¯èƒ½
CORSè¨­å®š	æœ‰åŠ¹ï¼ˆä»¥ä¸‹è©³ç´°ï¼‰
- Allow Origins	https://admin.myapp.example.com
- Allow Methods	GET, POST, PUT, DELETE, OPTIONS
- Allow Headers	Authorization, Content-Type
- Max Age	86400ï¼ˆç§’ï¼‰
ã‚¹ãƒ†ãƒ¼ã‚¸å	v1
ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°	ç’°å¢ƒæ¯ã®Lambda ARNã€ãƒ­ã‚°è¨­å®šãªã©
ãƒ­ã‚°è¨˜éŒ²	æœ‰åŠ¹ï¼ˆCloudWatch Logsï¼‰
ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ	JSONå½¢å¼ï¼ˆIPã€HTTPãƒ¡ã‚½ãƒƒãƒ‰ã€çµŒè·¯ã€status codeã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDãªã©ï¼‰
WAFé€£æº	CloudFrontçµŒç”±ã§ä¿è­·ï¼ˆWAF ACL: myapp-waf-webacl-prodï¼‰
ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆä»»æ„ï¼‰	api.myapp.example.comï¼ˆACMè¨¼æ˜æ›¸é€£æºï¼‰
ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼	CDK + GitLab CI/CD è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

ğŸ›  CDKãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆTypeScriptï¼‰
ts
å¤åˆ¶
ç¼–è¾‘
import { HttpApi, HttpMethod, CorsHttpMethod, DomainName } from 'aws-cdk-lib/aws-apigatewayv2';
import { HttpLambdaIntegration } from 'aws-cdk-lib/aws-apigatewayv2-integrations';
import { Certificate } from 'aws-cdk-lib/aws-certificatemanager';
import { Construct } from 'constructs';
import { Function } from 'aws-cdk-lib/aws-lambda';
import { Stack, StackProps } from 'aws-cdk-lib';

export class ApiGatewayProdStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const lambdaFunction = Function.fromFunctionArn(
      this,
      'ProdApiHandler',
      'arn:aws:lambda:ap-northeast-1:123456789012:function:myapp-lambda-api-handler-prod'
    );

    const integration = new HttpLambdaIntegration('LambdaIntegration', lambdaFunction);

    const certificate = Certificate.fromCertificateArn(
      this,
      'ApiCert',
      'arn:aws:acm:ap-northeast-1:123456789012:certificate/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'
    );

    const domain = new DomainName(this, 'CustomDomain', {
      domainName: 'api.myapp.example.com',
      certificate: certificate,
    });

    const httpApi = new HttpApi(this, 'HttpApiProd', {
      apiName: 'myapp-api-public-prod',
      corsPreflight: {
        allowHeaders: ['Authorization', 'Content-Type'],
        allowMethods: [CorsHttpMethod.GET, CorsHttpMethod.POST, CorsHttpMethod.PUT, CorsHttpMethod.DELETE, CorsHttpMethod.OPTIONS],
        allowOrigins: ['https://admin.myapp.example.com'],
        maxAge: Duration.seconds(86400),
      },
      defaultIntegration: integration,
    });

    httpApi.addStage('v1', {
      stageName: 'v1',
      autoDeploy: true,
    });

    httpApi.addDomainName('CustomDomainMapping', {
      domainName: domain,
    });
  }
}

WAFï¼ˆWebACLï¼‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°ï¼ˆprodç’°å¢ƒï¼‰
é …ç›®	è¨­å®šå€¤
WebACLå	myapp-waf-webacl-prod
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³	ap-northeast-1ï¼ˆâ€»CloudFrontç”¨ã®å ´åˆã¯ã€ŒGlobalã€ï¼‰
å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹	myapp-cf-prodï¼ˆCloudFront Distributionï¼‰
ã‚¹ã‚³ãƒ¼ãƒ—	CLOUDFRONTï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰ã¾ãŸã¯ REGIONALï¼ˆALB, API Gatewayç”¨ï¼‰
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³	ALLOW
ç®¡ç†ãƒ«ãƒ¼ãƒ«	AWS Managed Rules (AWS-AWSManagedRulesCommonRuleSet)
ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«	ã‚ã‚Šï¼ˆIPåˆ¶é™ã€æ—¥æœ¬å›½å†…ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ã«åˆ¶é™ãªã©ï¼‰
ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ï¼ˆä¾‹1ï¼‰	AllowJPOnly: å›½åˆ¥Geoãƒãƒƒãƒã§ JP ã®ã¿è¨±å¯
ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ï¼ˆä¾‹2ï¼‰	BlockIPBlacklist: ç‰¹å®šã®ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆIPã‚’ãƒ–ãƒ­ãƒƒã‚¯
ãƒ«ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³	ALLOW, BLOCK, COUNT
ãƒ¡ãƒˆãƒªã‚¯ã‚¹æœ‰åŠ¹åŒ–	æœ‰åŠ¹ï¼ˆCloudWatch Metricsé€£æºï¼‰
CloudWatchãƒ­ã‚°è¨˜éŒ²	æœ‰åŠ¹ï¼ˆKinesis Firehose â†’ S3ã«è»¢é€ã€Athenaå¯¾å¿œï¼‰
Logging destination ARN	arn:aws:firehose:ap-northeast-1:123456789012:deliverystream/waf-log-prod

ğŸ›  CDKãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆTypeScriptï¼‰
ts
å¤åˆ¶
ç¼–è¾‘
import { Stack, StackProps, Duration } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as wafv2 from 'aws-cdk-lib/aws-wafv2';
import * as cloudfront from 'aws-cdk-lib/aws-cloudfront';

export class WafWebAclProdStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const webAcl = new wafv2.CfnWebACL(this, 'MyAppWebAclProd', {
      name: 'myapp-waf-webacl-prod',
      scope: 'CLOUDFRONT', // Regionalã®å ´åˆã¯ 'REGIONAL'
      defaultAction: { allow: {} },
      visibilityConfig: {
        sampledRequestsEnabled: true,
        cloudWatchMetricsEnabled: true,
        metricName: 'myappWafWebAclProd',
      },
      rules: [
        {
          name: 'AWS-AWSManagedRulesCommonRuleSet',
          priority: 0,
          overrideAction: { none: {} },
          statement: {
            managedRuleGroupStatement: {
              name: 'AWSManagedRulesCommonRuleSet',
              vendorName: 'AWS',
            },
          },
          visibilityConfig: {
            sampledRequestsEnabled: true,
            cloudWatchMetricsEnabled: true,
            metricName: 'CommonRuleSet',
          },
        },
        {
          name: 'GeoMatchJPOnly',
          priority: 1,
          action: { allow: {} },
          statement: {
            geoMatchStatement: {
              countryCodes: ['JP'],
            },
          },
          visibilityConfig: {
            sampledRequestsEnabled: true,
            cloudWatchMetricsEnabled: true,
            metricName: 'GeoMatchJPOnly',
          },
        },
        {
          name: 'BlockBlacklistIPs',
          priority: 2,
          action: { block: {} },
          statement: {
            ipSetReferenceStatement: {
              arn: 'arn:aws:wafv2:ap-northeast-1:123456789012:regional/ipset/blacklist-prod/abcd1234-5678-xxxx-yyyy-zzzzzzzzzzzz',
            },
          },
          visibilityConfig: {
            sampledRequestsEnabled: true,
            cloudWatchMetricsEnabled: true,
            metricName: 'BlockBlacklistIPs',
          },
        },
      ],
    });

    // WAFã‚’CloudFrontãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢é€£ä»˜ã‘ï¼ˆCDK v2 ã§ã¯CfnAssociationã‚’ä½¿ç”¨ï¼‰
    new wafv2.CfnWebACLAssociation(this, 'WafAssociation', {
      resourceArn: 'arn:aws:cloudfront::123456789012:distribution/ABCDEFG123456',
      webAclArn: webAcl.attrArn,
    });
  }
}
ğŸ” è£œè¶³äº‹é …
IPSet ã®äº‹å‰ä½œæˆãŒå¿…è¦ï¼š

ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆIPç”¨ã®IPSetã‚’åˆ¥é€”ä½œæˆã—ã€ãã®ARNã‚’å‚ç…§ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

CloudFront ã¸ã®é–¢é€£ä»˜ã‘ï¼š

CloudFrontã® resourceArn ã¯ arn:aws:cloudfront::<account_id>:distribution/<distribution_id> ã®å½¢å¼ã€‚

ãƒ­ã‚°è¨­å®šï¼ˆçœç•¥å¯èƒ½ï¼‰ï¼š

Kinesis Firehose â†’ S3ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã€WAFãƒ­ã‚°ã‚’ä¿å­˜ã—ã¦Athenaã§æ¤œç´¢å¯èƒ½ã«ã§ãã¾ã™ã€‚

GeoMatchåˆ¶é™ï¼š

æ—¥æœ¬å›½å¤–ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ãŸã„å ´åˆã« GeoMatchStatement ãŒæœ‰åŠ¹ã§ã™ã€‚

CloudFront ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°ï¼ˆprodç’°å¢ƒï¼‰
é …ç›®	è¨­å®šå€¤
Distributionå	myapp-cf-prod
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³	ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆCloudFrontã¯Globalã‚µãƒ¼ãƒ“ã‚¹ï¼‰
ã‚ªãƒªã‚¸ãƒ³ã‚¿ã‚¤ãƒ—	AWS API Gateway HTTP API / S3 Static Website
ã‚ªãƒªã‚¸ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³	xxxxxx.execute-api.ap-northeast-1.amazonaws.com / myapp-static-prod.s3.amazonaws.com
ã‚ªãƒªã‚¸ãƒ³ID	api-origin / static-origin
ã‚ªãƒªã‚¸ãƒ³ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒªã‚·ãƒ¼	HTTPS Only
ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢ãƒ‘ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³	/api/*, /static/*, /*
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒªã‚·ãƒ¼	CachingDisabledï¼ˆAPIç”¨ï¼‰/ CachingOptimizedï¼ˆé™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ï¼‰
ã‚ªãƒªã‚¸ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªã‚·ãƒ¼	AllViewerExceptHostHeaderï¼ˆAPI Gateway ç½²åä»˜ãURLå¯¾å¿œï¼‰
ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒªã‚·ãƒ¼	Redirect HTTP to HTTPS
å¯¾å¿œHTTPãƒ¡ã‚½ãƒƒãƒ‰	GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETEï¼ˆAPIç”¨ï¼‰
åœ§ç¸®ï¼ˆgzip/brotliï¼‰	æœ‰åŠ¹
ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ 	API Gateway ã« x-api-key ã‚’é€ä¿¡
WAF WebACL	myapp-waf-webacl-prod ã‚’é–¢é€£ä»˜ã‘
ãƒ­ã‚°è¨˜éŒ²	æœ‰åŠ¹ï¼ˆS3 ãƒã‚±ãƒƒãƒˆ myapp-cf-logs-prod ã«ä¿å­˜ï¼‰
ãƒ­ã‚°ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹	prod/
ACMè¨¼æ˜æ›¸ï¼ˆHTTPSï¼‰	arn:aws:acm:us-east-1:123456789012:certificate/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆTTL	0ï¼ˆAPIç”¨ï¼‰ / 86400ï¼ˆé™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ï¼‰
ã‚¨ãƒƒã‚¸é–¢æ•°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰	Lambda@Edge ã«ã‚ˆã‚‹èªè¨¼ã€åœ°åŸŸåˆ¶é™ãªã©ï¼ˆæœªä½¿ç”¨ã§ã‚‚è¨˜è¼‰ï¼‰

ğŸ›  CDKãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆTypeScriptï¼‰
ts
å¤åˆ¶
ç¼–è¾‘
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as cloudfront from 'aws-cdk-lib/aws-cloudfront';
import * as origins from 'aws-cdk-lib/aws-cloudfront-origins';
import * as s3 from 'aws-cdk-lib/aws-s3';

export class CloudFrontProdStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // S3ãƒã‚±ãƒƒãƒˆï¼ˆé™çš„ã‚µã‚¤ãƒˆç”¨ï¼‰
    const staticBucket = s3.Bucket.fromBucketName(this, 'StaticBucket', 'myapp-static-prod');

    // CloudFront Distribution
    const distribution = new cloudfront.Distribution(this, 'MyAppCfProd', {
      defaultBehavior: {
        origin: new origins.HttpOrigin('xxxxxx.execute-api.ap-northeast-1.amazonaws.com', {
          originPath: '/prod',
          protocolPolicy: cloudfront.OriginProtocolPolicy.HTTPS_ONLY,
          customHeaders: {
            'x-api-key': '<<REPLACE_WITH_API_KEY>>',
          },
        }),
        allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
        cachePolicy: cloudfront.CachePolicy.CACHING_DISABLED,
        originRequestPolicy: cloudfront.OriginRequestPolicy.ALL_VIEWER_EXCEPT_HOST_HEADER,
        viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
        compress: true,
      },
      additionalBehaviors: {
        '/static/*': {
          origin: new origins.S3Origin(staticBucket),
          allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD,
          cachePolicy: cloudfront.CachePolicy.CACHING_OPTIMIZED,
          viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
          compress: true,
        },
      },
      domainNames: ['www.example.com'],
      certificate: cdk.aws_certificatemanager.Certificate.fromCertificateArn(
        this,
        'MyCert',
        'arn:aws:acm:us-east-1:123456789012:certificate/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'
      ),
      webAclId: 'arn:aws:wafv2:global:123456789012:global/webacl/myapp-waf-webacl-prod/abcd1234-xxxx-yyyy-zzzz-abcdefabcdef',
      enableLogging: true,
      logBucket: s3.Bucket.fromBucketName(this, 'LogBucket', 'myapp-cf-logs-prod'),
      logFilePrefix: 'prod/',
      defaultRootObject: '',
    });
  }
}
ğŸ” è£œè¶³äº‹é …
WAFã¨ã®é€£æºï¼š

CloudFront ã«ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«WAF (scope: CLOUDFRONT) ã®WebACLã‚’é–¢é€£ä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

HTTPSè¨¼æ˜æ›¸ï¼š

CloudFrontç”¨ã®ACMè¨¼æ˜æ›¸ã¯ us-east-1 ã«å­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

API Gateway Originã®æ³¨æ„ç‚¹ï¼š

originPath ã«ã‚¹ãƒ†ãƒ¼ã‚¸åï¼ˆä¾‹ï¼š/prodï¼‰ã‚’æ˜ç¤ºçš„ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

APIã‚­ãƒ¼ãªã©ã‚’ customHeaders ã§ä»˜åŠ å¯èƒ½ã€‚

ãƒ­ã‚°ä¿å­˜å…ˆï¼š

S3ãƒ­ã‚°ãƒã‚±ãƒƒãƒˆã¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æ˜ç¤ºçš„ã«è¨­å®šã—ã€CloudFrontã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ä¿ç®¡å¯èƒ½ã§ã™ã€‚

additionalBehaviors ã®æ´»ç”¨ï¼š

APIã¨é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã§æŒ™å‹•ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‹ã“ã¨ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€å¤§åŒ–ã€‚

 Lambda ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°ï¼ˆprodç’°å¢ƒï¼‰
é …ç›®	è¨­å®šå€¤ä¾‹ãƒ»èª¬æ˜
é–¢æ•°å	myapp-lambda-api-handler-prod
ãƒ©ãƒ³ã‚¿ã‚¤ãƒ 	python3.12
ãƒãƒ³ãƒ‰ãƒ©	app.lambda_handler
ãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚º	1024 MBï¼ˆAPIãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ¨™æº–çš„ãªæ€§èƒ½ã‚’è€ƒæ…®ï¼‰
ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ	30 ç§’ï¼ˆå¤–éƒ¨APIå‘¼ã³å‡ºã—ã‚„DBã‚¢ã‚¯ã‚»ã‚¹ã‚’æƒ³å®šï¼‰
ç’°å¢ƒå¤‰æ•°	ä¸‹è¨˜ä¾‹å‚ç…§ï¼ˆAPIã‚­ãƒ¼ã€DBæ¥ç¶šæƒ…å ±ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãªã©ï¼‰
ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸	S3ãƒã‚±ãƒƒãƒˆã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆmyapp-lambda-code-bucket-prod ã® api-handler.zipï¼‰
IAMå®Ÿè¡Œãƒ­ãƒ¼ãƒ«	myapp-role-lambda-exec-prodï¼ˆæœ€å°æ¨©é™ä»˜ä¸ã€DynamoDBã‚¢ã‚¯ã‚»ã‚¹ã€CloudWatch Logsæ›¸è¾¼ã¿è¨±å¯å«ã‚€ï¼‰
VPCè¨­å®š	æœªè¨­å®šï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦ãªå ´åˆã¯VPCãŠã‚ˆã³NAT Gatewayè¨­å®šã‚’æ¤œè¨ï¼‰
DLQ (Dead Letter Queue)	SQSã‚­ãƒ¥ãƒ¼ã¾ãŸã¯SNSãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹ï¼šmyapp-lambda-dlq-prodï¼‰è¨­å®šæ¨å¥¨
å†è©¦è¡Œè¨­å®š	æœ€å¤§2å›ã®è‡ªå‹•å†è©¦è¡Œ
ãƒ¬ã‚¤ãƒ¤ãƒ¼	å¿…è¦ã«å¿œã˜ã¦å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ç”¨ï¼ˆä»Šå›ã¯ç„¡ã—ï¼‰
ãƒˆãƒªã‚¬ãƒ¼	API Gateway HTTP API (prodã‚¹ãƒ†ãƒ¼ã‚¸)
ãƒ­ã‚°å‡ºåŠ›	CloudWatch Logsï¼ˆãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—å /aws/lambda/myapp-lambda-api-handler-prodï¼‰
ã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ‰ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°	AWS Lambda Insights æœ‰åŠ¹åŒ–æ¨å¥¨
ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥	ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹ã€Aliasåˆ©ç”¨ã§Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œ

ç’°å¢ƒå¤‰æ•°ä¾‹ï¼ˆprodï¼‰
å¤‰æ•°å	å†…å®¹ä¾‹	å‚™è€ƒ
ENV	prod	ç’°å¢ƒè­˜åˆ¥ç”¨
LOG_LEVEL	INFO	ãƒ­ã‚°ã®è©³ç´°åº¦
DDB_TABLE_NAME	myapp-ddb-users-prod	DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«å
API_KEY	xxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	API Gatewayåˆ©ç”¨æ™‚ã®èªè¨¼ã‚­ãƒ¼
SNS_TOPIC_ARN	arn:aws:sns:ap-northeast-1:123456789012:myapp-sns-alarm-prod	éšœå®³é€šçŸ¥ç”¨SNSãƒˆãƒ”ãƒƒã‚¯ARN
OTHER_CONFIG	...	è¿½åŠ è¨­å®šãŒã‚ã‚Œã°è¿½è¨˜

ğŸ›  CDKãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆTypeScriptï¼‰
ts
å¤åˆ¶
ç¼–è¾‘
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as iam from 'aws-cdk-lib/aws-iam';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as sns from 'aws-cdk-lib/aws-sns';

export class LambdaProdStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Lambdaå®Ÿè¡Œç”¨IAMãƒ­ãƒ¼ãƒ«
    const lambdaRole = new iam.Role(this, 'LambdaExecRole', {
      roleName: 'myapp-role-lambda-exec-prod',
      assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com'),
      description: 'Lambdaå®Ÿè¡Œãƒ­ãƒ¼ãƒ«ï¼ˆprodç’°å¢ƒï¼‰',
      managedPolicies: [
        iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSLambdaBasicExecutionRole'), // CloudWatch Logs
      ],
    });

    // DynamoDBã‚„SNSã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã¯å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
    lambdaRole.addToPolicy(new iam.PolicyStatement({
      actions: [
        'dynamodb:GetItem',
        'dynamodb:PutItem',
        'dynamodb:UpdateItem',
        'sns:Publish',
      ],
      resources: [
        'arn:aws:dynamodb:ap-northeast-1:123456789012:table/myapp-ddb-users-prod',
        'arn:aws:sns:ap-northeast-1:123456789012:myapp-sns-alarm-prod',
      ],
    }));

    // Lambdaé–¢æ•°ã®å®šç¾©
    const lambdaFunc = new lambda.Function(this, 'ApiHandler', {
      functionName: 'myapp-lambda-api-handler-prod',
      runtime: lambda.Runtime.PYTHON_3_12,
      handler: 'app.lambda_handler',
      code: lambda.Code.fromBucket(
        s3.Bucket.fromBucketName(this, 'LambdaCodeBucket', 'myapp-lambda-code-bucket-prod'),
        'api-handler.zip'
      ),
      memorySize: 1024,
      timeout: cdk.Duration.seconds(30),
      role: lambdaRole,
      environment: {
        ENV: 'prod',
        LOG_LEVEL: 'INFO',
        DDB_TABLE_NAME: 'myapp-ddb-users-prod',
        API_KEY: 'xxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
        SNS_TOPIC_ARN: 'arn:aws:sns:ap-northeast-1:123456789012:myapp-sns-alarm-prod',
      },
      // ãƒ‡ãƒƒãƒ‰ãƒ¬ã‚¿ãƒ¼ã‚­ãƒ¥ãƒ¼ã‚„å†è©¦è¡Œè¨­å®šã¯å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
      // retryAttempts: 2, // CDKã§ã¯ç¾çŠ¶æ˜ç¤ºçš„ãªè¨­å®šã¯Lambdaã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã®æ–¹ã§è¡Œã†ã“ã¨ãŒå¤šã„
    });

    // Lambda Insights ã®æœ‰åŠ¹åŒ–ä¾‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    /*
    lambdaFunc.addExtension(new lambda.LayerVersion(this, 'LambdaInsightsLayer', {
      compatibleRuntimes: [lambda.Runtime.PYTHON_3_12],
      code: lambda.Code.fromAsset('path/to/lambda-insights-layer'),
    }));
    */
  }
}
ğŸ” è£œè¶³
DLQï¼ˆDead Letter Queueï¼‰ ã®è¨­å®šã¯ã€Lambdaã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã«ã‚ˆã£ã¦æŒ‡å®šã—ã¾ã™ã€‚API Gatewayç›´æ¥èµ·å‹•ã®å ´åˆã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãŒç„¡ã„ãŸã‚ã€DLQè¨­å®šã¯Lambdaå´ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€CloudWatchã‚¢ãƒ©ãƒ¼ãƒ ã‚„æ‰‹å‹•ãƒªãƒˆãƒ©ã‚¤ã§è£œå®Œã—ã¾ã™ã€‚

ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°é‹ç”¨ï¼šlambdaFunc.addAlias('prod') ãªã©ã§åˆ¥é€”Aliasã‚’ä½œã‚Šã€Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ã«å‚™ãˆã¾ã™ã€‚

VPCæ¥ç¶šï¼šå¤–éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ãŒå¿…è¦ãªå ´åˆã¯ã€Lambdaã«VPCè¨­å®šã‚’è¿½åŠ ã—ã€NAT GatewayçµŒç”±ã®é€šä¿¡ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®ç®¡ç†ã¯ç’°å¢ƒå¤‰æ•°ã§åˆ‡ã‚Šæ›¿ãˆã‚‹å½¢ãŒä¸€èˆ¬çš„ã§ã™ã€‚
