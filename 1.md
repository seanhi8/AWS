# AWS WAF 詳細設計書

## 1. 基本情報

| 項目           | 内容                                           |
|----------------|------------------------------------------------|
| ドキュメント名 | AWS WAF 詳細設計書                             |
| 作成日         | 2025年6月26日                                  |
| 作成者         | [貴社担当者名]                                 |
| 対象システム   | Webサイトフロント／API基盤                      |
| 対象サービス   | AWS CloudFront、API Gateway（HTTP API）         |

---

## 2. WebACL 設定概要

| 項目               | 内容                                               |
|--------------------|----------------------------------------------------|
| WebACL 名          | `project-main-webacl`                             |
| WAF バージョン     | WAFv2                                              |
| 適用リージョン     | Global（CloudFront）、ap-northeast-1（API Gateway）|
| ルール数           | 5                                                  |
| デフォルトアクション | Allow（ルールに該当しない場合）                   |
| ログ出力先（任意） | CloudWatch Logs / S3 バケット（設定予定）         |

---

## 3. フロントサイト／パスパターン一覧

### ■ CloudFront（静的Webサイト）

| 対象ドメイン              | パスパターン     | WAF適用 | 備考                            |
|---------------------------|------------------|---------|---------------------------------|
| `https://www.example.com` | `/login*`        | ○       | ボット対策、SQLi対策            |
|                           | `/admin/*`       | ○       | IP制限、Refererチェック         |
|                           | `/assets/*`      | ×       | 静的ファイル、WAF対象外         |
|                           | `/healthcheck`   | ×       | モニタリング用途、除外対象       |

### ■ API Gateway（バックエンドAPI）

| 対象ドメイン              | パスパターン         | WAF適用 | 備考                     |
|---------------------------|----------------------|---------|--------------------------|
| `https://api.example.com` | `/api/v1/*`          | ○       | レート制限、SQLi/XSS 対策 |
|                           | `/api/internal/*`    | ○       | Referer/IP 制限          |
|                           | `/api/healthcheck`   | ×       | 除外                     |

---

## 4. WAFルール設計

| ルール名              | 種別           | 条件例                                                   | アクション  | 適用対象         |
|-----------------------|----------------|------------------------------------------------------------|-------------|------------------|
| `rule-ip-whitelist`   | カスタムルール | `/admin/*` かつ IPが許可リストに含まれていない            | Block       | CloudFront       |
| `rule-referer-check`  | カスタムルール | `/admin/*` かつ Referer に `example.com` 含まれない        | CAPTCHA     | CloudFront       |
| `rule-sqli-protect`   | マネージドルール | `AWSManagedRulesSQLiRuleSet`                              | Block       | 全体             |
| `rule-xss-protect`    | マネージドルール | `AWSManagedRulesXSSRuleSet`                               | Block       | 全体             |
| `rule-api-rate-limit` | レート制限     | `/api/v1/*` に対して 5分あたり1000件以上のアクセス         | Block       | API Gateway      |

---

## 5. 除外パス（WAF対象外）

| サービス       | パス                  | 理由                         |
|----------------|-----------------------|------------------------------|
| CloudFront     | `/assets/*`           | 画像・JSなど静的ファイル     |
| API Gateway    | `/api/healthcheck`    | モニタリング用               |

---

## 6. ログ出力（オプション）

| 項目         | 内容                                           |
|--------------|------------------------------------------------|
| ログ保存先   | `waf-logs-example` S3バケット（ログ専用）      |
| ログ形式     | JSON                                           |
| 保持期間     | 365日（S3ライフサイクル設定による自動削除）   |

---

## 7. 備考

- CloudFront と API Gateway に対して別々の WebACL を作成し適用。
- `/admin/*` パスは最も厳格な制御を設ける。
- 除外パスでは不要なログや費用の増加を防止。
- IP制限・Referer・Rate制限はルールグループ単位で柔軟に管理できるよう設計。
