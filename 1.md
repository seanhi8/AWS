# システム基本設計書（Basic Design Document）

## 1. システム概要

本システムは、オンプレミス環境とクラウド（AWS）上の機能を連携させ、APIを介して情報の送受信を行うハイブリッド構成のWebアプリケーションです。AWSサービスを活用してセキュアかつスケーラブルな基盤を構築し、ユーザーおよび管理者向けのインタフェースを提供します。システム構築には AWS CDK（Cloud Development Kit）を採用し、コードベースでインフラ定義と自動化を行います。

---

## 2. システム構成図（概要）

- **Frontend/Local連携系**：HTTP API Gateway + Lambda  
- **Backend管理系**：CloudFront + WAF + HTTP API Gateway + Lambda  
- **共通基盤**：S3、DynamoDB、EventBridge、CloudWatch、SNS  

---

## 3. 使用サービスと役割

| サービス | 役割 |
|----------|------|
| S3 | Lambdaコード（ZIP）の格納、イベント通知連携、静的コンテンツ保存 |
| CloudFront | 管理者画面への静的コンテンツ配信（S3オリジン） |
| WAF | 不正アクセス対策（Core Rule Set使用）、CloudFront連携 |
| API Gateway (HTTP API) | フロント/バックエンドからのリクエスト受け口、Lambda統合（AWS_PROXY） |
| Lambda (Python 3.12) | 業務ロジック処理（APIリクエスト、DB操作、外部連携等） |
| DynamoDB | データストア、PITR（35日）有効化、単一テーブル設計想定 |
| EventBridge | S3イベントトリガー管理、イベント駆動処理拡張性確保 |
| CloudWatch | Lambda/APIGatewayログ出力、メトリクス監視、アラーム設定 |
| SNS | 通知（アラーム時メール配信、Slack連携なども可能） |

---

## 4. 環境構成

| 項目 | 内容 |
|------|------|
| 環境種別 | dev / stg / prod |
| リージョン | ap-northeast-1（東京） |
| Lambda実行環境 | Python 3.12、S3よりZIP取得、自動バージョニング対応予定 |
| API Gateway種別 | HTTP API（Lambda統合、CORS設定有） |
| S3バケット | lambda-code-bucket-<env>, frontend-assets-<env> 等命名規則 |

---

## 5. 命名規則（Naming Convention）

全体として「プレフィックス + サービス種別 + 環境名」形式を基本とし、統一された命名規則により可視性と保守性を確保します。

| リソース | 命名規則 | 例 |
|----------|-----------|----|
| S3バケット | `<project>-<用途>-bucket-<env>` | `myapp-lambda-code-bucket-dev` |
| Lambda関数名 | `<project>-lambda-<role>-<env>` | `myapp-lambda-api-handler-stg` |
| API Gateway名 | `<project>-api-<用途>-<env>` | `myapp-api-public-prod` |
| DynamoDBテーブル | `<project>-ddb-<用途>-<env>` | `myapp-ddb-users-prod` |
| SNSトピック | `<project>-sns-<用途>-<env>` | `myapp-sns-alarm-prod` |
| CloudWatchロググループ | `/aws/lambda/<Lambda名>` | `/aws/lambda/myapp-lambda-api-handler-stg` |
| IAMロール | `<project>-role-<用途>-<env>` | `myapp-role-lambda-exec-prod` |
| CloudFront | `<project>-cf-<env>` | `myapp-cf-prod` |
| WAF WebACL | `<project>-waf-webacl-<env>` | `myapp-waf-webacl-prod` |

※ `<project>` はプロジェクト略称や部門名（例：myapp, erp, billing 等）とし、CI/CD用には追加のブランチ名や日付タイムスタンプも付与可能。

---

## 6. 機能一覧

### 6.1 フロントエンド連携機能（オンプレ連携）

- オンプレシステムからHTTP API経由でLambdaを呼び出す  
- リクエスト検証後、DynamoDBへデータ登録  
- レスポンスはJSON形式で返却  

### 6.2 バックエンド管理機能

- 管理者向けWeb画面をS3に配置し、CloudFront経由で配信  
- CloudFrontはWAFで保護され、APIアクセスはHTTP API Gateway経由  
- API Gateway → Lambda → DynamoDBへのアクセス  
- ログ・メトリクスをCloudWatchへ集約  

---

## 7. セキュリティ設計

- **WAF**：AWS Managed Rules（Core Rule Set）適用、Geo制限/IP制限拡張可能  
- **IAM**：最小権限の原則に基づきCDKでロール設計（Lambda実行、API Gatewayアクセス）  
- **S3**：すべてのバケットでSSE-S3暗号化／ブロックパブリックアクセス有効化  
- **Lambda/API Gateway**：リクエスト元の制限、環境変数のKMS暗号化など  
- **VPC内Lambda**の採用検討（将来的に内部通信のセキュア化）  
- **AWS Config**を活用した構成監査（drift検出）も順次導入予定  

---

## 8. 可観測性・監視（運用監視）

### ログ管理方針

- **CloudWatch Logs保存期間**：
  - dev環境：7日
  - stg環境：14日
  - prod環境：90日（S3へ定期転送あり）
- 90日超のログはAthena検索用としてS3に保存（GLUEカタログ登録済）  
- 保存先バケットにはライフサイクルポリシーを適用（1年後Glacier）  

### アラーム設定（CloudWatch Alarm）

- Lambda Function Error >= 1（5分間隔、2回以上）  
- API Gateway 5XX エラー >= 1（1分間隔、連続2回）  
- DynamoDB Throttleイベントが発生時  
- CloudFront 4XX > 5% or 5XX > 1%（過去5分平均）  
- アラーム発報時はSNSを通じてメール通知（Slack、OpsGenie等連携も可能）  

### ダッシュボード構成

- Lambda成功率・実行時間・エラーレート  
- API Gateway統計（レイテンシ・ステータスコード）  
- CloudFrontリクエスト統計（キャッシュヒット率など）  
- DynamoDB使用率、読み書きスロットリング数  

### 再試行・障害対策

- Lambda関数には最大再試行回数指定（最大2回）  
- 失敗時はDLQ（SQS）へ送信し、再処理機構により回復力強化  

---

## 9. イベント駆動設計

- LambdaコードのZIPアップロード（S3）によりEventBridgeトリガー発火  
- 連動Lambdaでコード検証・ログ記録などの拡張処理が可能  
- 将来的にはStep Functions連携も視野に入れる  

---

## 10. 拡張性・開発戦略

- AWS CDK（TypeScript or Python）により構成を一元管理  
- `dev → stg → prod` の順にデプロイ、CodePipelineまたはGitLab CIでCI/CD実装を予定  
- バージョン管理／Alias運用でBlue/Green Deployの実装容易  
- ACMの導入はCloudFrontのHTTPS対応時に段階導入（現時点は未使用）  
- Lambdaのレイヤー管理、コード分割方針、ライブラリ統一化も開発指針に追加  

---

## 11. CI/CD設計

### CI/CD構成（CodePipeline or GitLab CI）

- CodeCommit または GitLab リポジトリにCDKプロジェクトをPushすると、パイプラインが起動  
- GitLab CI/CD の `.gitlab-ci.yml` によるジョブ定義（Build, Synth, Deploy）  
- CodeBuildではCDK Synth → Deploy（環境毎にステージ分岐）  
- Lambda用ZIPファイルはS3へアップロード、EventBridge検出後に自動更新Lambdaが起動  
- 各環境（dev/stg/prod）ごとに手動承認（ManualApproval）ステージをCodePipelineまたはGitLab環境タグで管理  

#### GitLab CI ジョブ例

```yaml
deploy:
  stage: deploy
  image: node:18
  script:
    - npm install -g aws-cdk
    - npm install
    - cdk synth
    - cdk deploy --require-approval never
  only:
    - main
