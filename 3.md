# 負荷試験仕様書（模擬本番環境・大規模トラフィック）

## 1. 目的

本試験は、Webブラウザを通じたユーザー操作を模倣し、CloudFront、WAF、S3、API Gateway、Lambda、DynamoDB、EC2等の構成要素を通過する処理に対して、システム全体の性能・スケーラビリティ・ボトルネックの有無を検証することを目的とする。

---

## 2. システム構成概要

| 区分       | 内容 |
|------------|------|
| フロント   | CloudFront → WAF → S3（静的Web） → API Gateway → Lambda（認証等） |
| バックエンド | API Gateway → EC2（VPC内） |
| 共通基盤   | S3（ファイル保存）、DynamoDB（データ管理）、Lambda（ステートレス処理） |
| 備考       | Lambda はすべて VPC 外部に配置されており、必要な連携は API Gateway 経由で行う |

---

## 3. 試験環境

- ステージング環境（本番同等スペック）
- データボリューム：本番相当（1万ファイル / 100万レコード相当）
- WAF・CloudFront 設定も本番相当

---

## 4. 試験ユーザ数・負荷パターン

| パターン | 同時ユーザー数 | 想定内容 | 継続時間 | 合計リクエスト目安 |
|----------|----------------|----------|----------|---------------------|
| 通常負荷 | 200人 | 通常利用ペース | 30分 | 約10万 |
| 高負荷 | 1000人 | 業務時間ピークの模倣 | 30分 | 約50万 |
| スパイク | 5000人 | 急激アクセス（リリース直後等） | 10分 | 約200万 |
| 耐久負荷 | 500人 | 長時間運用時の安定性確認 | 6時間 | 約100万 |

---

## 5. 試験シナリオ・詳細テストケース（抜粋）

### シナリオ1：ログイン認証（Lambda → DynamoDB）

- **操作手順**：ログインフォーム入力 → 認証ボタン押下  
- **実行API**：`POST /api/auth/login`  
- **チェック点**：
  - レスポンスが200であること
  - トークンが返却されること
  - DynamoDB にセッション記録が存在すること
- **期待結果**：
  - 平均レスポンス < 1.5秒
  - 成功率 > 99%
  - スロットル発生なし

---

### シナリオ2：ファイルアップロード（S3）

- **操作手順**：ファイル選択 → アップロード → 成功通知表示  
- **実行API**：`PUT`（署名付きURL → S3）  
- **チェック点**：
  - ファイルがS3に保存されていること
  - DynamoDB にメタ情報が記録されること
- **期待結果**：
  - 応答時間 < 2秒
  - 同時1000件でも成功率99%以上

---

### シナリオ3：一括翻訳（Lambdaバッチ処理）

- **操作手順**：複数項目を選択 → 翻訳実行  
- **実行API**：`POST /api/translate/batch`  
- **チェック点**：
  - 非同期で処理が開始される
  - 結果がS3に格納され、DynamoDBに反映される
- **期待結果**：
  - 各翻訳平均 < 5秒（10件）
  - 成功率 > 99%

---

### シナリオ4：VPC内EC2 APIとの連携

- **操作手順**：バックエンド処理ボタン押下 → 内部API呼び出し  
- **実行API**：`GET /api/legacy/process`  
- **チェック点**：
  - EC2からのレスポンス確認
  - 結果がブラウザに表示される
- **期待結果**：
  - 応答時間 < 2秒
  - タイムアウト・失敗なし

---

### シナリオ5：ファイル一覧取得・フィルタ・ページング操作

- **操作手順**：一覧画面 → フィルタ入力 → ページ移動  
- **実行API**：`GET /api/files?filter=...&page=...`  
- **チェック点**：
  - データ数・並び順・フィルタ一致
- **期待結果**：
  - 応答時間 < 1秒
  - 正確なページングと一致率

---

### シナリオ6：エラーハンドリング確認（不正入力）

- **操作手順**：不正トークン・欠損ファイルでリクエスト  
- **実行API**：全主要API  
- **チェック点**：
  - 適切なHTTPステータス（401/403/422）
  - CloudWatch Logsへの記録
- **期待結果**：
  - 全APIが適切にエラー処理
  - 500系エラーを返さない

---

## 6. 使用ツールと構成

| カテゴリ | 使用ツール |
|----------|-------------|
| 負荷生成 | k6 / JMeter |
| 監視 | CloudWatch / X-Ray / Lambda Insights |
| ログ | CloudWatch Logs / S3 |
| 可視化 | Grafana / Excel集計 |

---

## 7. 判定基準（主要KPI）

| 評価項目 | 基準値 |
|----------|--------|
| レスポンス時間 | 通常3秒以内、高負荷時95%が5秒以内 |
| 成功率 | 各API 98%以上、エラー率 < 2% |
| スループット | 5000 RPSに耐えられる |
| スケーリング | Lambda・DynamoDB の自動拡張が正常動作 |
| 安定性 | 長時間処理中に性能劣化なし |
| エラー処理 | 全APIが予期しない入力に対し適切に応答する |

---

## 8. 結果報告・考察（試験後作成）

- 応答時間の分布（平均・P95・P99）
- スループットの傾向分析
- Lambda/EC2のボトルネック有無
- 改善提案（キャッシュ化・レート制御など）

---

## 9. ボトルネック判定項目一覧（瓶頸現象の対照表）

| No. | 対象コンポーネント | 想定される瓶頸現象 | 観測指標 | 判定方法 | 判定基準/備考 |
|-----|----------------------|----------------------|------------|------------|----------------|
| 1 | API Gateway | 応答遅延、504エラー | `Latency`, `IntegrationLatency`, `5XX` | CloudWatch メトリクス | `Latency > 3000ms`が継続、または`5XX` > 1% |
| 2 | Lambda | 実行時間長い、タイムアウト、冷起動 | `Duration`, `Throttles`, `InitDuration`, `Errors` | Lambda メトリクス + X-Ray | `Duration > 5000ms`や`Throttles`発生時 |
| 3 | DynamoDB | RCU/WCU超過、レスポンス遅延 | `ConsumedReadCapacity`, `ThrottledRequests`, `SuccessfulRequestLatency` | CloudWatch メトリクス | `Throttled > 0`や`Latency > 200ms`継続時 |
| 4 | EC2連携 | 応答タイムアウト、接続失敗 | `IntegrationLatency`, X-Ray, VPC Flow Logs | X-Rayトレースマップで赤いノード出現 | `Integration Timeout` や `504` 発生時 |
| 5 | CloudFront | キャッシュヒット率低い、レスポンス遅延 | CloudFront Access Logs / `HitRatio` | CloudFrontログ + ResponseTimeグラフ | キャッシュヒット率 < 80%かつ遅延が増加 |
| 6 | WAF | 誤検知によるブロック | WAFログ（BlockedCount） | CloudWatch + AccessLogs | 正常なリクエストが403となる場合 |
| 7 | S3アップロード | PUT失敗、遅延、署名URL失効 | S3 access logs + クライアント側ログ | 署名URL発行時刻 vs リクエスト時刻 | `PUT`の4xx/5xxが1%以上 |
| 8 | バッチ翻訳処理 | 処理失敗、部分完了 | Lambda logs, S3出力ファイル確認 | 件数一致確認 + 正常ファイル出力 | 出力件数 < リクエスト件数、または欠損あり |
| 9 | ページング/検索 | 遅延、不一致、DBオーバークエリ | DynamoDBアクセス数, フィルタ条件 | ページ切り替え時のAPIレスポンス & DB統計 | 1ページ応答 > 2秒、件数不一致時要確認 |
| 10 | システム全体 | スループット劣化、オートスケール不能 | 全体RPS, ステージ状態, スロットリング数 | DashBoard全体比較 | 負荷上昇に対し性能上がらない場合はボトルネック疑い |

---

### ✅ テスト担当者向け確認手順：

- [ ] 各シナリオ実施時に上記項目をリアルタイムで確認またはログとして記録
- [ ] スパイク負荷（同時5000ユーザー）時に各メトリクス急変を重点確認
- [ ] CloudWatch DashboardおよびX-Rayでボトルネック視覚的に確認
- [ ] `errors.log`, `timeout.log`, `slow-response.log` に分類保存し、事後レビュー

---

### 📌 備考：

- ボトルネックを検知した場合、再現条件・影響範囲・リカバリ動作を記録し、別途「性能改善提案書」にて報告すること。
- 本表は試験後のレポートテンプレートにも活用可能。
