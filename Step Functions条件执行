import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as sfn from 'aws-cdk-lib/aws-stepfunctions';
import * as tasks from 'aws-cdk-lib/aws-stepfunctions-tasks';
import * as logs from 'aws-cdk-lib/aws-logs';
import * as cloudwatch from 'aws-cdk-lib/aws-cloudwatch';
import * as sns from 'aws-cdk-lib/aws-sns';
import * as sns_actions from 'aws-cdk-lib/aws-sns-actions';

export class StepFunctionStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // 1. 创建用于记录日志的 Lambda 函数
    const logLambda = new lambda.Function(this, 'LogLambda', {
      runtime: lambda.Runtime.NODEJS_14_X, // 运行时为 Node.js 14
      handler: 'index.handler', // Lambda 函数入口
      code: lambda.Code.fromInline(`
        exports.handler = async (event) => {
          console.log('Step execution skipped or failed:', event);  // 打印日志到 CloudWatch Logs
          return event;  // 返回 event，以便后续处理
        };
      `),
    });

    // 2. 创建 CloudWatch Logs 组，设置日志保留期为 1 年
    const logGroup = new logs.LogGroup(this, 'MyLogGroup', {
      retention: logs.RetentionDays.ONE_YEAR, // 设置日志保留期为 1 年
    });

    // 3. 创建 SNS 主题，用于接收警报
    const snsTopic = new sns.Topic(this, 'StepFunctionFailureTopic', {
      displayName: 'Step Function Failure Alerts', // SNS 主题显示名称
    });

    // 4. 监控 Step Functions 执行失败，设置 CloudWatch 警报
    const stepFunctionFailureMetric = new cloudwatch.Metric({
      namespace: 'AWS/States', // Step Functions 的命名空间
      metricName: 'Failed', // 监控 "Failed" metric
      dimensionsMap: {
        StateMachineArn: 'your-state-machine-arn', // 将此替换为你自己的 Step Functions ARN
      },
      statistic: 'Sum', // 使用总和 (sum) 统计
      period: cdk.Duration.minutes(1), // 每 1 分钟计算一次
    });

    // 创建 CloudWatch 警报，当失败次数 >= 1 时触发
    const failureAlarm = new cloudwatch.Alarm(this, 'StepFunctionFailureAlarm', {
      metric: stepFunctionFailureMetric, // 监控 "Failed" metric
      threshold: 1, // 失败次数阈值为 1
      evaluationPeriods: 1, // 1 个评估周期
      comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_OR_EQUAL_TO_THRESHOLD, // 比较运算符
      alarmDescription: 'Alarm when Step Function fails', // 警报描述
    });

    // 连接警报到 SNS 主题，失败时会通过 SNS 发送通知
    failureAlarm.addAlarmAction(new sns_actions.SnsAction(snsTopic));

    // 5. 创建 Step Functions 的步骤

    /**
     * 工具函数：构建一个由多个 Lambda 组成的 Step Functions 子流程
     * 每个 Lambda 会作为 LambdaInvoke 任务依次执行，使用 .next() 链接
     */
    function buildStep(scope: Construct, namePrefix: string, lambdas: lambda.IFunction[]): sfn.IChainable {
      const tasksList = lambdas.map((fn, index) => new tasks.LambdaInvoke(scope, `${namePrefix}-Lambda${index + 1}`, {
        lambdaFunction: fn, // 设置 Lambda 函数
        outputPath: '$.Payload', // 获取 Lambda 函数的输出
      }));

      // 用 reduce 将多个 Task 串联为一个执行链
      return tasksList.reduce((chain, nextTask) => chain.next(nextTask));
    }

    // 假设你已经创建了这些 Lambda 函数，可以替换为 fromFunctionName 或 fromFunctionArn
    const step1Lambdas = [lambda1, lambda2, lambda3];
    const step2Lambdas = [lambda4, lambda5, lambda6];
    const step3Lambdas = [lambda7, lambda8, lambda9];
    const step4Lambdas = [lambda10, lambda11, lambda12];
    const step5Lambdas = [lambda13, lambda14, lambda15];

    // 构建每个步骤的任务链
    const step1 = buildStep(this, 'Step1', step1Lambdas);
    const step2 = buildStep(this, 'Step2', step2Lambdas);
    const step3 = buildStep(this, 'Step3', step3Lambdas);
    const step4 = buildStep(this, 'Step4', step4Lambdas);
    const step5 = buildStep(this, 'Step5', step5Lambdas);

    // 6. 创建跳过步骤用的 Pass 节点
    const skip2 = new sfn.Pass(this, 'SkipStep2');
    const skip3 = new sfn.Pass(this, 'SkipStep3');
    const skip4 = new sfn.Pass(this, 'SkipStep4');
    const skip5 = new sfn.Pass(this, 'SkipStep5');
    const endState = new sfn.Pass(this, 'End');

    // 7. 处理步骤执行的判断：判断 $.output 是否为 'yesdoit'，决定是否执行下一个 Step
    const check1 = new sfn.Choice(this, 'Check Step1 Output')
      .when(sfn.Condition.stringEquals('$.output', 'yesdoit'), step2)  // 如果 output 为 'yesdoit'，执行 step2
      .otherwise(skip2);  // 否则跳过 step2

    const check2 = new sfn.Choice(this, 'Check Step2 Output')
      .when(sfn.Condition.stringEquals('$.output', 'yesdoit'), step3)
      .otherwise(skip3);

    const check3 = new sfn.Choice(this, 'Check Step3 Output')
      .when(sfn.Condition.stringEquals('$.output', 'yesdoit'), step4)
      .otherwise(skip4);

    const check4 = new sfn.Choice(this, 'Check Step4 Output')
      .when(sfn.Condition.stringEquals('$.output', 'yesdoit'), step5)
      .otherwise(skip5);

    // 8. 任务链和跳过节点连接起来
    step1.next(check1);  // Step1 执行完后检查判断是否执行 Step2
    step2.next(check2);
    skip2.next(check2);  // 如果 Step2 被跳过，执行检查 Step3

    step3.next(check3);
    skip3.next(check3);

    step4.next(check4);
    skip4.next(check4);

    step5.next(endState);
    skip5.next(endState);

    // 9. 结合日志记录步骤
    const logStep = new tasks.LambdaInvoke(this, 'Log Step Skipped', {
      lambdaFunction: logLambda,  // 使用日志记录的 Lambda
      payload: sfn.TaskInput.fromObject({
        message: 'Step was skipped or failed',  // 记录日志的消息
        stepOutput: '$.output',  // 输出当前 Step 的 output 作为日志
      }),
      resultPath: '$.log',  // 保存日志结果
    });

    // 将 logStep 连接到跳过节点，确保每次跳过时都有日志记录
    step1.next(logStep).next(check1);
    step2.next(logStep).next(check2);
    skip2.next(logStep).next(check2);
    step3.next(logStep).next(check3);
    skip3.next(logStep).next(check3);
    step4.next(logStep).next(check4);
    skip4.next(logStep).next(check4);
    step5.next(logStep).next(endState);
    skip5.next(logStep).next(endState);

    // 10. 创建 Step Functions 状态机
    new sfn.StateMachine(this, 'ConditionalStateMachine', {
      definition: step1,  // 从 Step1 开始
      timeout: cdk.Duration.minutes(15),  // 状态机超时设置为 15 分钟
    });
  }
}

---------------------------------------------------------------------------------------
代码逻辑详解：
1.日志记录 Lambda (logLambda)：

这个 Lambda 用来记录所有跳过的步骤和失败的步骤。日志会输出到 CloudWatch Logs，方便后期追踪。

2.CloudWatch Logs 配置：

logGroup 是用来保存 CloudWatch Logs 的日志组。我们设置了日志保留期为 1 年，超过时间后会自动删除。

3.CloudWatch 警报 (failureAlarm)：

我们为 Step Functions 设置了一个 CloudWatch 警报，用来监控状态机的失败。只要 Failed metric 被触发，警报就会通过 SNS 发送通知。

4.状态机步骤 (step1 到 step5)：

每个 Step 由多个 Lambda 组成，任务链使用 .next() 方法连接。每个 Step 的输出传递到下一个步骤。

5.判断条件 (Choice 节点)：

每个步骤的判断条件检查 $.output 是否为 'yesdoit'，如果是，执行下一个步骤。如果不是或没有输出，跳过该步骤。

6.日志记录和跳过节点 (logStep, skipX)：

如果某个步骤被跳过，logStep 会记录日志到 CloudWatch，说明该步骤被跳过或失败。

7.状态机创建：

最后创建了一个状态机，定义了步骤的执行顺序和超时设置。
---------------------------------------------------------------------------------------
AWSTemplateFormatVersion: '2010-09-09'
Description: Step Functions workflow with conditional branches and CloudWatch alarm

Parameters:
  Lambda1Arn:
    Type: String
  Lambda2Arn:
    Type: String
  Lambda3Arn:
    Type: String
  Lambda4Arn:
    Type: String
  Lambda5Arn:
    Type: String
  Lambda6Arn:
    Type: String
  Lambda7Arn:
    Type: String
  Lambda8Arn:
    Type: String
  Lambda9Arn:
    Type: String
  Lambda10Arn:
    Type: String
  Lambda11Arn:
    Type: String
  Lambda12Arn:
    Type: String
  Lambda13Arn:
    Type: String
  Lambda14Arn:
    Type: String
  Lambda15Arn:
    Type: String
  LogLambdaArn:
    Type: String

Resources:
  StepFunctionExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: AllowLambdaInvoke
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: '*'

  StepFunctionStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      RoleArn: !GetAtt StepFunctionExecutionRole.Arn
      StateMachineType: STANDARD
      DefinitionString:
        Fn::Sub: |
          {
            "StartAt": "Step1-Lambda1",
            "States": {
              "Step1-Lambda1": { "Type": "Task", "Resource": "${Lambda1Arn}", "Next": "Step1-Lambda2" },
              "Step1-Lambda2": { "Type": "Task", "Resource": "${Lambda2Arn}", "Next": "Step1-Lambda3" },
              "Step1-Lambda3": { "Type": "Task", "Resource": "${Lambda3Arn}", "Next": "Step1-Log" },
              "Step1-Log": {
                "Type": "Task",
                "Resource": "${LogLambdaArn}",
                "Next": "Step1-Choice",
                "Parameters": {
                  "message": "Step1 was skipped or failed"
                }
              },
              "Step1-Choice": {
                "Type": "Choice",
                "Choices": [
                  {
                    "Variable": "$.output",
                    "StringEquals": "yesdoit",
                    "Next": "Step2-Lambda4"
                  }
                ],
                "Default": "Step2-Skip"
              },

              "Step2-Skip": { "Type": "Pass", "Next": "Step2-Log" },
              "Step2-Log": {
                "Type": "Task",
                "Resource": "${LogLambdaArn}",
                "Next": "Step2-Choice",
                "Parameters": {
                  "message": "Step2 was skipped or failed"
                }
              },
              "Step2-Choice": {
                "Type": "Choice",
                "Choices": [
                  {
                    "Variable": "$.output",
                    "StringEquals": "yesdoit",
                    "Next": "Step3-Lambda7"
                  }
                ],
                "Default": "Step3-Skip"
              },
              "Step2-Lambda4": { "Type": "Task", "Resource": "${Lambda4Arn}", "Next": "Step2-Lambda5" },
              "Step2-Lambda5": { "Type": "Task", "Resource": "${Lambda5Arn}", "Next": "Step2-Lambda6" },
              "Step2-Lambda6": { "Type": "Task", "Resource": "${Lambda6Arn}", "Next": "Step2-Log" },

              "Step3-Skip": { "Type": "Pass", "Next": "Step3-Log" },
              "Step3-Log": {
                "Type": "Task",
                "Resource": "${LogLambdaArn}",
                "Next": "Step3-Choice",
                "Parameters": {
                  "message": "Step3 was skipped or failed"
                }
              },
              "Step3-Choice": {
                "Type": "Choice",
                "Choices": [
                  {
                    "Variable": "$.output",
                    "StringEquals": "yesdoit",
                    "Next": "Step4-Lambda10"
                  }
                ],
                "Default": "Step4-Skip"
              },
              "Step3-Lambda7": { "Type": "Task", "Resource": "${Lambda7Arn}", "Next": "Step3-Lambda8" },
              "Step3-Lambda8": { "Type": "Task", "Resource": "${Lambda8Arn}", "Next": "Step3-Lambda9" },
              "Step3-Lambda9": { "Type": "Task", "Resource": "${Lambda9Arn}", "Next": "Step3-Log" },

              "Step4-Skip": { "Type": "Pass", "Next": "Step4-Log" },
              "Step4-Log": {
                "Type": "Task",
                "Resource": "${LogLambdaArn}",
                "Next": "Step4-Choice",
                "Parameters": {
                  "message": "Step4 was skipped or failed"
                }
              },
              "Step4-Choice": {
                "Type": "Choice",
                "Choices": [
                  {
                    "Variable": "$.output",
                    "StringEquals": "yesdoit",
                    "Next": "Step5-Lambda13"
                  }
                ],
                "Default": "Step5-Skip"
              },
              "Step4-Lambda10": { "Type": "Task", "Resource": "${Lambda10Arn}", "Next": "Step4-Lambda11" },
              "Step4-Lambda11": { "Type": "Task", "Resource": "${Lambda11Arn}", "Next": "Step4-Lambda12" },
              "Step4-Lambda12": { "Type": "Task", "Resource": "${Lambda12Arn}", "Next": "Step4-Log" },

              "Step5-Skip": { "Type": "Pass", "Next": "Step5-Log" },
              "Step5-Log": {
                "Type": "Task",
                "Resource": "${LogLambdaArn}",
                "Next": "End",
                "Parameters": {
                  "message": "Step5 was skipped or failed"
                }
              },
              "Step5-Lambda13": { "Type": "Task", "Resource": "${Lambda13Arn}", "Next": "Step5-Lambda14" },
              "Step5-Lambda14": { "Type": "Task", "Resource": "${Lambda14Arn}", "Next": "Step5-Lambda15" },
              "Step5-Lambda15": { "Type": "Task", "Resource": "${Lambda15Arn}", "Next": "Step5-Log" },

              "End": { "Type": "Pass", "End": true }
            }
          }

Outputs:
  StateMachineArn:
    Description: ARN of the created Step Function
    Value: !Ref StepFunctionStateMachine

---------------------------------------------------------------------------------------

import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as sfn from 'aws-cdk-lib/aws-stepfunctions';
import * as tasks from 'aws-cdk-lib/aws-stepfunctions-tasks';

export class StepFunctionStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    /**
     * 工具函数：构建一个由多个 Lambda 组成的 Step Functions 子流程
     * 每个 Lambda 会作为 LambdaInvoke Task 依次执行，使用 .next() 链接
     */
    function buildStep(scope: Construct, namePrefix: string, lambdas: lambda.IFunction[]): sfn.IChainable {
      const tasksList = lambdas.map((fn, index) => new tasks.LambdaInvoke(scope, `${namePrefix}-Lambda${index + 1}`, {
        lambdaFunction: fn,
        outputPath: '$.Payload',
      }));

      // 用 reduce 将多个 Task 串联为一个执行链
      return tasksList.reduce((chain, nextTask) => chain.next(nextTask));
    }

    /**
     * 假设你已经创建了这些 Lambda 函数，可替换为 fromFunctionName 或 fromFunctionArn
     */
    const step1Lambdas = [lambda1, lambda2, lambda3];
    const step2Lambdas = [lambda4, lambda5, lambda6];
    const step3Lambdas = [lambda7, lambda8, lambda9];
    const step4Lambdas = [lambda10, lambda11, lambda12];
    const step5Lambdas = [lambda13, lambda14, lambda15];

    // 构建每个步骤的任务链
    const step1 = buildStep(this, 'Step1', step1Lambdas);
    const step2 = buildStep(this, 'Step2', step2Lambdas);
    const step3 = buildStep(this, 'Step3', step3Lambdas);
    const step4 = buildStep(this, 'Step4', step4Lambdas);
    const step5 = buildStep(this, 'Step5', step5Lambdas);

    // 创建跳过步骤用的 Pass 节点
    const skip2 = new sfn.Pass(this, 'SkipStep2');
    const skip3 = new sfn.Pass(this, 'SkipStep3');
    const skip4 = new sfn.Pass(this, 'SkipStep4');
    const skip5 = new sfn.Pass(this, 'SkipStep5');
    const endState = new sfn.Pass(this, 'End');

    // 每个 Choice 判断是否 output == 'yes'
    const check1 = new sfn.Choice(this, 'Check Step1 Output')
      .when(sfn.Condition.stringEquals('$.output', 'yes'), step2)
      .otherwise(skip2);

    const check2 = new sfn.Choice(this, 'Check Step2 Output')
      .when(sfn.Condition.stringEquals('$.output', 'yes'), step3)
      .otherwise(skip3);

    const check3 = new sfn.Choice(this, 'Check Step3 Output')
      .when(sfn.Condition.stringEquals('$.output', 'yes'), step4)
      .otherwise(skip4);

    const check4 = new sfn.Choice(this, 'Check Step4 Output')
      .when(sfn.Condition.stringEquals('$.output', 'yes'), step5)
      .otherwise(skip5);

    // 串联整个流程：Step1 -> Check -> Step2 -> Check -> ... -> Step5 -> End
    step1.next(check1);
    step2.next(check2);
    skip2.next(check2);

    step3.next(check3);
    skip3.next(check3);

    step4.next(check4);
    skip4.next(check4);

    step5.next(endState);
    skip5.next(endState);

    // 创建状态机
    new sfn.StateMachine(this, 'ConditionalStateMachine', {
      definition: step1,
      timeout: cdk.Duration.minutes(15),
    });
  }
}




AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 複雑な条件分岐を含む 5 段階のステップ関数ワークフロー（Lambda による判定）

Resources:
  MyStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: My5StepWorkflow
      RoleArn: arn:aws:iam::123456789012:role/StepFunctionsExecutionRole  # 必要な実行ロールに置き換えてください
      Definition:
        Version: '1.0'
        Comment: "5ステップのワークフロー。各ステップ間に複雑な条件判定あり。Lambdaによる実装。"
        StartAt: State1
        States:

          # --- ステップ 1 ---
          State1:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:State1Function  # ステップ1の処理Lambda
            Next: Judge1

          # 判定用Lambda（ステップ1 → ステップ2 の間で使用）
          Judge1:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:Judge1Function
            ResultPath: $.judgeResult  # 戻り値は $.judgeResult.condition に格納される
            Next: Choice1

          # 条件に基づき分岐
          Choice1:
            Type: Choice
            Choices:
              - Variable: $.judgeResult.condition
                StringEquals: a
                Next: DoA1
              - Variable: $.judgeResult.condition
                StringEquals: b
                Next: DoB1
              - Variable: $.judgeResult.condition
                StringEquals: c
                Next: DoC1
            Default: Skip1  # d の場合はスキップ（何もしない）

          DoA1:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleA1
            Next: State2

          DoB1:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleB1
            Next: State2

          DoC1:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleC1
            Next: State2

          Skip1:
            Type: Pass
            Next: State2

          # --- ステップ 2 ---
          State2:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:State2Function
            Next: Judge2

          Judge2:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:Judge2Function
            ResultPath: $.judgeResult
            Next: Choice2

          Choice2:
            Type: Choice
            Choices:
              - Variable: $.judgeResult.condition
                StringEquals: a
                Next: DoA2
              - Variable: $.judgeResult.condition
                StringEquals: b
                Next: DoB2
              - Variable: $.judgeResult.condition
                StringEquals: c
                Next: DoC2
            Default: Skip2

          DoA2:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleA2
            Next: State3

          DoB2:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleB2
            Next: State3

          DoC2:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleC2
            Next: State3

          Skip2:
            Type: Pass
            Next: State3

          # --- ステップ 3 ---
          State3:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:State3Function
            Next: Judge3

          Judge3:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:Judge3Function
            ResultPath: $.judgeResult
            Next: Choice3

          Choice3:
            Type: Choice
            Choices:
              - Variable: $.judgeResult.condition
                StringEquals: a
                Next: DoA3
              - Variable: $.judgeResult.condition
                StringEquals: b
                Next: DoB3
              - Variable: $.judgeResult.condition
                StringEquals: c
                Next: DoC3
            Default: Skip3

          DoA3:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleA3
            Next: State4

          DoB3:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleB3
            Next: State4

          DoC3:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleC3
            Next: State4

          Skip3:
            Type: Pass
            Next: State4

          # --- ステップ 4 ---
          State4:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:State4Function
            Next: Judge4

          Judge4:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:Judge4Function
            ResultPath: $.judgeResult
            Next: Choice4

          Choice4:
            Type: Choice
            Choices:
              - Variable: $.judgeResult.condition
                StringEquals: a
                Next: DoA4
              - Variable: $.judgeResult.condition
                StringEquals: b
                Next: DoB4
              - Variable: $.judgeResult.condition
                StringEquals: c
                Next: DoC4
            Default: Skip4

          DoA4:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleA4
            Next: State5

          DoB4:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleB4
            Next: State5

          DoC4:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:HandleC4
            Next: State5

          Skip4:
            Type: Pass
            Next: State5

          # --- ステップ 5（最終） ---
          State5:
            Type: Task
            Resource: arn:aws:lambda:REGION:ACCOUNT_ID:function:State5Function
            End: true
