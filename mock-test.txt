# ğŸ› ï¸ CDK ä¸»çŠ¶æ€æœºéƒ¨ç½²æŒ‡å—ï¼ˆå« Mock æµ‹è¯•ï¼‰

æœ¬æŒ‡å—å°†å¼•å¯¼ä½ å¦‚ä½•ä½¿ç”¨ CDK éƒ¨ç½²ä¸» Step Function çŠ¶æ€æœºï¼Œå¹¶é€šè¿‡ Mock çŠ¶æ€æœºä¸ S3 å­˜å‚¨æ¡¶è¿›è¡Œè”åŠ¨æµ‹è¯•ã€‚

---

## ğŸ“¦ é¡¹ç›®ç»“æ„è¯´æ˜

ä½ ç°åœ¨æ‹¥æœ‰ 3 ä¸ªç‹¬ç«‹çš„ CDK é¡¹ç›®ï¼š

| é¡¹ç›®åç§°              | åŠŸèƒ½è¯´æ˜                              |
|------------------------|----------------------------------------|
| `mock-step-functions`  | æ¨¡æ‹Ÿ Step1 ~ Step5 çš„å­çŠ¶æ€æœº          |
| `mock-s3-buckets`      | åˆ›å»ºç”¨äºæµ‹è¯•çš„ S3 å­˜å‚¨æ¡¶ bucket001~003 |
| `cdk-master-step`      | å®ç°ä¸»æ§åˆ¶æµç¨‹çš„ Step Function         |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### âœ… ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½² Mock S3 å­˜å‚¨æ¡¶

```bash
cd mock-s3-buckets
npm install
cdk deploy
````

ğŸ“‹ è¯·è®°ä¸‹ç»ˆç«¯è¾“å‡ºçš„ bucket åç§°ï¼š

```
Bucket001Name = mock-bucket-001-123456789012-us-east-1
Bucket002Name = mock-bucket-002-123456789012-us-east-1
Bucket003Name = mock-bucket-003-123456789012-us-east-1
```

---

### âœ… ç¬¬äºŒæ­¥ï¼šéƒ¨ç½² Mock å­çŠ¶æ€æœº Step1 \~ Step5

```bash
cd mock-step-functions
npm install
cdk deploy
```

ğŸ“‹ è¯·è®°ä¸‹ç»ˆç«¯è¾“å‡ºçš„æ¯ä¸ªçŠ¶æ€æœº ARNï¼š

```
Step1Arn = arn:aws:states:us-east-1:123456789012:stateMachine:mock-step-1
...
```

---

### âœ… ç¬¬ä¸‰æ­¥ï¼šé…ç½®ä¸»é¡¹ç›® `.env` æ–‡ä»¶

ç¼–è¾‘æ–‡ä»¶ï¼š`cdk-master-step/.env`

```env
STEP1_ARN=arn:aws:states:us-east-1:...:mock-step-1
STEP2_ARN=...
STEP3_ARN=...
STEP4_ARN=...
STEP5_ARN=...

BUCKET001=mock-bucket-001-123456789012-us-east-1
BUCKET002=mock-bucket-002-123456789012-us-east-1
BUCKET003=mock-bucket-003-123456789012-us-east-1
```

---

### âœ… ç¬¬å››æ­¥ï¼šéƒ¨ç½²ä¸»çŠ¶æ€æœº

```bash
cd cdk-master-step
npm install
./deploy.sh
```

---

## âœ… çŠ¶æ€æœºè¾“å…¥/è¾“å‡ºç¤ºä¾‹

æ‰€æœ‰ mock çŠ¶æ€æœºéƒ½æ¥å—ç©ºå¯¹è±¡ `{}` ä½œä¸ºè¾“å…¥ï¼Œè¿”å›å›ºå®šç»“æ„ä½œä¸ºè¾“å‡ºï¼š

* Step1:

  ```json
  { "step1Result": { "step": 1, "status": "OK" } }
  ```

* Step2:

  ```json
  { "step2Result": { "step": 2, "status": "OK" } }
  ```

* Step3:

  ```json
  { "step3Result": { "step": 3, "executed": true } }
  ```

* Step4:

  ```json
  { "step4Result": { "step": 4, "status": "OK" } }
  ```

* Step5:

  ```json
  { "step5Result": { "step": 5, "executed": true } }
  ```

---

## ğŸ§ª æ¨¡æ‹Ÿ S3 å­˜å‚¨æ¡¶å†…å®¹å˜åŒ–ï¼ˆæµ‹è¯• Step3 / Step5 æ¡ä»¶åˆ¤æ–­ï¼‰

### simulate-s3-contents.sh

```bash
#!/bin/bash
set -e

BUCKET002="mock-bucket-002-xxxxxxxxxxxx-region"
BUCKET003="mock-bucket-003-xxxxxxxxxxxx-region"

echo "test" > temp002.txt
echo "test" > temp003.txt

aws s3 cp temp002.txt s3://$BUCKET002/test-002.txt
aws s3 cp temp003.txt s3://$BUCKET003/test-003.txt
```

è¿è¡Œè¯¥è„šæœ¬ä¼šå‘ bucket002 å’Œ bucket003 ä¸Šä¼ ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œç”¨äºæ¨¡æ‹Ÿâ€œéç©ºâ€çŠ¶æ€ã€‚

---

### clear-s3-buckets.sh

```bash
#!/bin/bash
set -e

BUCKET002="mock-bucket-002-xxxxxxxxxxxx-region"
BUCKET003="mock-bucket-003-xxxxxxxxxxxx-region"

aws s3 rm s3://$BUCKET002 --recursive
aws s3 rm s3://$BUCKET003 --recursive
```

è¿è¡Œè¯¥è„šæœ¬å¯ä»¥æ¸…ç©º bucket002 å’Œ bucket003 å†…å®¹ï¼Œç”¨äºæ¨¡æ‹Ÿâ€œç©ºâ€çŠ¶æ€ã€‚

---

## âœ… æµ‹è¯•ä¸»çŠ¶æ€æœºæµç¨‹

1. æ‰“å¼€ AWS æ§åˆ¶å° â†’ Step Functions é¡µé¢ï¼›
2. é€‰æ‹© `master` çŠ¶æ€æœºï¼›
3. ç‚¹å‡»â€œå¼€å§‹æ‰§è¡Œâ€ï¼ˆStart executionï¼‰ï¼Œè¾“å…¥ `{}`ï¼›
4. æŸ¥çœ‹æ‰§è¡Œæµå›¾ã€å˜é‡ã€ç»“æœã€‚

---

## ğŸ§¹ èµ„æºæ¸…ç†ï¼ˆå¯é€‰ï¼‰

```bash
cd mock-s3-buckets && cdk destroy
cd ../mock-step-functions && cdk destroy
cd ../cdk-master-step && cdk destroy
```

---

## ğŸ” å°æç¤º

* ç¡®ä¿ä½ å·²æ­£ç¡®é…ç½® AWS CLI çš„å‡­è¯ï¼›
* å¦‚åœ¨ GitHub Actions ä¸­ä½¿ç”¨ï¼Œéœ€å°† ARN å’Œ bucket åé…ç½®ä¸º Secretsï¼›
* æ‰€æœ‰ mock èµ„æºå‡æ”¯æŒè‡ªåŠ¨é”€æ¯ï¼ˆ`removalPolicy: DESTROY` + `autoDeleteObjects`ï¼‰ã€‚

```
