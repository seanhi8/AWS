<?php
use cms\site\hobby\lib\AwsS3ClientComponent;
use cms\site\hobby\lib\BackendArticleAwsS3ClientComponent;
use cms\site\hobby\lib\FrontArticleAwsS3ClientComponent;
use cms\site\hobby\lib\SitemapAwsS3ClientComponent;
use cms\site\hobby\lib\MailComponent;

/**
 * バナー
 */
class Tool extends 
{
    /**
     * コンストラクタ
     */
    public function __construct($logger = null)
    {
        parent::__construct($logger);
    }

    /**
     * クラスのPathを取得する
     *
     * @return string 実体化クラスファイルのPath
     */
    protected function getPath()
    {
        return dirname(__FILE__);
    }

    /**
     * API実行用のエントリポイント
     */
    public function exec($action = null, $params = [])
    {
        $this->logger->debug(get_called_class() . '::' . __FUNCTION__, $params);

        // ユーザーアクセス（ブラウザ等）の場合のみ認証を実施する
        if ($this->isUserAccess()) {
            $this->validateAuthHeader(); // 認証メソッドを呼び出し
        }

        if (method_exists($this, $action)) {
            return $this->$action($params);
        } else {
            return false;
        }
    }

    /**
     * Authorizationヘッダーによる認証処理
     *
     * 特定のTokenでのみ実行を許可する
     */
    public function validateAuthHeader()
    {
        // 許可されたToken一覧（必要に応じて設定ファイルなどに分離可能）
        $allowedTokens = [
            'abc123', // 特定ユーザーA
            'xyz789', // 特定ユーザーB
        ];

        $authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';

        if (!preg_match('/^Bearer\s+(.*)$/', $authHeader, $matches)) {
            header('HTTP/1.1 401 Unauthorized');
            echo json_encode(['error' => 'Authorization header missing or invalid']);
            exit;
        }

        $token = $matches[1];

        if (!in_array($token, $allowedTokens, true)) {
            header('HTTP/1.1 403 Forbidden');
            echo json_encode(['error' => 'Invalid token']);
            exit;
        }
    }

    /**
     * ブラウザなどユーザー直接アクセスかどうかを判定
     * CLIやシステム内部呼び出しではfalseを返す
     */
    private function isUserAccess()
    {
        return isset($_SERVER['HTTP_USER_AGENT']) && !empty($_SERVER['HTTP_USER_AGENT']);
    }
}
