
# 🔐 認証機能設計書（方式②：外部トークン設定ファイル方式）

## 📌 概要

本ドキュメントは、`tool.php` ファイルに認証機能を追加するための設計書です。特定ユーザーのみがアクセス可能となるよう、トークンによる認証方式を採用し、既存の処理や他プログラムへの影響を避けつつ安全性を高めることを目的とします。

---

## 🗂 対象ファイル

| パス | 説明 |
|------|------|
| `/home/dev-test/private/slim4_abc_merge/cms/site/abc/package/tool.php` | 認証対象の実装ファイル |
| `/home/dev-test/private/slim4_abc_merge/cms/site/abc/config/tokens.php` | トークン一覧を定義する新規ファイル |

---

## 🔧 認証仕様

| 項目 | 内容 |
|------|------|
| 認証方式 | HTTPヘッダ：`Authorization: Bearer {token}` |
| トークン形式 | ランダムな文字列（例：`abc123token`） |
| 認証対象 | tool.php に直接アクセスするユーザー |
| 除外対象 | 他のPHPプログラム等からの内部呼び出し（ヘッダなし） |
| 失敗時 | HTTP 403 Forbidden を返して処理停止 |

---

## 🛠 トークン設定ファイル（tokens.php）

```php
<?php
// 認証に使用するトークンリスト
return [
    'user0001' => 'abc123token',
    'user0002' => 'def456token',
];


---

🧩 認証コード（tool.php 冒頭に追加）

<?php

// トークン一覧を読み込み
$tokenList = include __DIR__ . '/../config/tokens.php';

// Authorizationヘッダの取得と整形
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $authHeader);

// トークンが正しいか検証
$authenticated = in_array($token, $tokenList);

// 認証が必要な場合のみ検査（内部処理からの実行はスルー）
if ($authHeader && !$authenticated) {
    header('HTTP/1.1 403 Forbidden');
    echo json_encode(['error' => '認証に失敗しました']);
    exit;
}


---

🔄 呼び出し条件と結果

呼び出し元	Authorization ヘッダ	結果

ユーザーAPI	あり（正しいトークン）	実行許可
ユーザーAPI	あり（不正なトークン）	403 Forbidden
内部処理	なし	通常通り実行（認証スキップ）



---

🛡 セキュリティ対策

tokens.php は Web 非公開ディレクトリ内に配置

トークンは十分に複雑なランダム文字列を使用（例：openssl rand -hex 16）

.gitignore による除外で Git に漏れないよう対策

不正リクエストに対する403応答あり



---

📁 ディレクトリ構成

cms/
└── site/
    └── abc/
        ├── config/
        │   └── tokens.php   ← トークン定義ファイル
        └── package/
            └── tool.php     ← 認証コード追加対象


---

✅ チェックリスト

項目	状態

[ ] tokens.php が所定の場所に作成されている	
[ ] tokens.php に必要なトークンが記載されている	
[ ] tool.php に認証コードが追加されている	
[ ] ユーザーAPIから適切に Authorization ヘッダが送信されている	
[ ] 内部呼び出しは影響を受けずに実行できる	
[ ] Git にトークンファイルが含まれていない	
[ ] トークンは十分に強力なランダム文字列を使用している	



---
