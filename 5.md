
# 共通実行制御（exec）への簡易認証機能追加 仕様書

---

## 1. 背景・目的

本仕様書は、既存のPHPアプリケーションにおける共通実行制御モジュール（以下、「exec」と記載）に対し、特定APIパスを保護するための簡易認証機能を追加するための設計指針を定める。

対象となるAPI `/cms/site/abc/package/tool` は、本来特定のユーザーのみが操作可能であるべき機能であるが、現状は認証保護されていない。そこで、最小限の実装負荷かつ既存機能に影響を与えない形で、静的トークンによる認証制御を共通処理に追加する。

---

## 2. 対象システム・構成

| 項目             | 内容                                       |
|------------------|--------------------------------------------|
| 実行環境         | PHP 8.3                                    |
| フレームワーク   | Slim Framework 4.x                         |
| 認証対象パス     | `/cms/site/abc/package/tool`               |
| 対象ユーザー     | `user0001`                                 |
| 実装対象ファイル | 共通実行モジュール `exec.php`             |
| HTTP種別         | HTTP API（Authorizationヘッダー使用）     |

---

## 3. 認証方式

### 3.1 認証方法の概要

- HTTP リクエストヘッダー `Authorization` に付与された固定トークンを検証
- 指定されたパス（`/cms/site/abc/package/tool`）に対してのみ適用
- トークン不一致時は `401 Unauthorized` を返却し処理を中断
- トークン一致時は既存処理をそのまま継続実行

### 3.2 トークン仕様

| 項目        | 内容                              |
|-------------|-----------------------------------|
| トークン形式 | `Bearer user0001-abc-secure-token` |
| 検証方法    | 文字列一致による比較               |
| 保管場所    | PHPコード内に直接定義（簡易実装）  |
| 暗号化      | なし（平文でのヘッダー比較）       |

---

## 4. 実装方針

### 4.1 実装場所

以下のファイルの冒頭（任意の処理前）に挿入する：

/home/dev-test/private/slim4_abc_merge/exec.php

### 4.2 処理フロー概要

1. `$_SERVER['REQUEST_URI']` で現在のリクエストパスを取得
2. 対象パスに該当するかを `strpos()` で判定
3. `$_SERVER['HTTP_AUTHORIZATION']` よりトークンを取得
4. 許可トークンと一致しない場合、401 エラーを返却して `exit`
5. 一致する場合、既存の処理へ遷移

### 4.3 実装コード

```php
<?php
// 認証制御処理（exec.phpの先頭に追加）

$requestUri = $_SERVER['REQUEST_URI'] ?? '';
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$validToken = 'Bearer user0001-abc-secure-token';

$isProtectedPath = strpos($requestUri, '/cms/site/abc/package/tool') !== false;

if ($isProtectedPath && $authHeader !== $validToken) {
    http_response_code(401);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Unauthorized']);
    exit;
}

※ Apacheやnginx構成によっては $_SERVER['REDIRECT_HTTP_AUTHORIZATION'] を使用する必要あり。


---

5. エラーハンドリング

条件	HTTPステータス	レスポンス内容

認証成功	200	通常の処理結果（既存ロジック通り）
認証失敗（トークン不一致）	401	{ "error": "Unauthorized" }（JSON形式）
Authorizationヘッダーなし	401	同上



---

6. 非影響範囲

以下の条件では本認証ロジックはスキップされ、既存機能に一切の影響を与えない：

REQUEST_URI が /cms/site/abc/package/tool に該当しない場合

トークンが一致している場合

Slimルーティングとは無関係な CLI 実行や別用途の exec 呼び出し時



---

7. 保守性・拡張性

項目	将来的な対応

トークンの管理	.env ファイルや外部設定ファイルに切り出し可能
対象パスの追加	$isProtectedPath に OR 条件で複数パスを追加
複数ユーザー対応	$validToken を配列にして in_array() で検証
JWT化対応	ライブラリ導入により将来的に段階的に強化可能
ログ出力	不正アクセスのログ出力（logファイルや監査対応）可



---

8. セキュリティ上の注意事項

トークンは簡易的な静的文字列比較のため、運用上の厳重な管理が必要

HTTPS 経由での通信を前提とし、通信路の盗聴リスクを回避

トークンの漏洩が発生した場合、即時トークン変更・再デプロイが必要

外部公開APIへの展開には向かず、内部限定運用が前提



---

9. テスト項目

テストケース	期待結果

正常：正しいトークンでアクセス	200レスポンス（API正常動作）
異常：トークンが不一致	401 Unauthorized エラー
異常：Authorizationヘッダーなし	同上
異常：対象外パスへアクセス	認証処理スキップ、通常通り動作



---

10. 実装・レビュー履歴

日付	内容	担当

2025-07-15	初版作成・設計	PG（あなた）
YYYY-MM-DD	実装・レビュー完了	（レビュワー）

3. 影響範囲

項目	内容

対象	tool.php のすべてのリクエスト（CLI実行などを除く）
影響	トークン未設定、またはトークン不一致時に403となるため、既存フロント／APIクライアントとの連携動作の事前確認が必要
排他対象	他PHPファイルへの影響なし（tool.php単体に限る）


4. 想定されるリスクと対策

リスク	対策

トークン漏洩	環境変数・設定ファイルのパーミッション制御、HTTPS運用を推奨
他ファイルへの影響	他ファイルには影響がないようにtool.php単体に実装
キャッシュ・リバースプロキシ	キャッシュの有効範囲に注意、常に認証が行われるように設計


5. 実装前チェックリスト

[x] 正常なトークンによるアクセスで処理が継続されることを確認

[x] 不正なトークン／トークンなしの場合403になることを確認

[x] CLIやCronなどからの内部呼出しが影響を受けないことを確認

[x] 本番／検証環境それぞれで想定動作を確認

[x] バージョン管理（Git等）により差分管理されていること

[x] トークン値の共有先／管理方法の合意があること


6. 導入手順（例）

1. 認証コードを tool.php 冒頭に追加


2. 必要に応じて config.php 等のトークン設定ファイルを作成


3. テスト環境にて動作確認（正常アクセス／異常アクセス）


4. 本番環境へデプロイ（事前通知・同意取得）


5. 必要に応じてドキュメント／READMEを更新
