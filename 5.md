認証機能設計書（外部トークン設定ファイル方式）

対象：tool.php（Slim4ベースシステム）
作成日：2025年7月
作成者：ChatGPT


---

1. 目的

本設計書は、tool.php ファイル内の処理に対して、特定ユーザーによる認証制御を導入することで、外部からの不正アクセスや不正操作を防止することを目的とします。

対象ユーザーは事前に設定したトークンを所持する者のみ。

他プログラムや非ユーザーの処理には影響を与えない設計とする。

トークンは PHP 配列ファイルとして外部管理し、tool.php 側で読み込んで照合。



---

2. 対象ファイル

ファイルパス	役割

/home/dev-test/private/slim4_abc_merge/cms/site/abc/package/tool.php	API処理本体、認証処理追加対象
/home/dev-test/private/slim4_abc_merge/cms/site/abc/config/tokens.php	トークン定義ファイル（新規追加）



---

3. 認証仕様

項目	内容

認証方法	Authorization ヘッダに Bearer {token} を付加し送信
トークン形式	プレーン文字列（例：abc123token）
検証手段	tokens.php に定義された値と一致するかどうかで判定
成功時	tool.php の処理を実行可能
失敗時	403 Forbidden を返却し処理を中断
トークン保存	tokens.php にハードコード形式で格納（配列）



---

4. tokens.php ファイル仕様（新規作成）

<?php
// 認証トークン設定
return [
    'user0001' => 'abc123token',
    'user0002' => 'def456token',
    // 必要に応じて追加
];


---

5. tool.php 側の認証コード（ヘッダ部分に追加）

<?php

// 外部トークン設定ファイルの読み込み
$tokenList = include __DIR__ . '/../config/tokens.php';

// Authorizationヘッダからトークン取得
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $authHeader);

// トークンリストから照合
$authenticated = in_array($token, $tokenList);

// 認証失敗時は403を返して終了
if ($authHeader && !$authenticated) {
    header('HTTP/1.1 403 Forbidden');
    echo json_encode(['error' => '認証に失敗しました']);
    exit;
}

> 💡 注意：他プログラムから tool.php を呼び出す際に Authorization ヘッダを送らない場合は認証スキップ（後述参照）
よって、「ユーザーから直接アクセス」したときのみ認証が働くようになります。




---

6. トークン照合処理の条件分岐仕様

呼び出し元	Authorization ヘッダ	結果

ユーザーAPI	あり（Bearer 付与）	トークン一致 → 実行許可
ユーザーAPI	あり（不一致）	403 Forbidden
内部処理呼び出し	なし	スルー（認証バイパス）



---

7. セキュリティ対策

トークンは .php ファイル形式で、外部からアクセス不可のディレクトリ内に保存

トークンの文字列は推測されにくいランダム値を設定（例：openssl rand -hex 16 で生成）

必要に応じてIP制限やリクエストレート制限も追加可能



---

8. ファイル構成例

cms/
└── site/
    └── abc/
        ├── config/
        │   └── tokens.php      ← トークン定義
        └── package/
            └── tool.php        ← 認証処理を追加


---

9. チェックリスト ✅

チェック項目	状態

[ ] tokens.php が正しいパスに存在する	
[ ] tokens.php に正しいユーザー・トークンが記載されている	
[ ] tool.php に認証コードがヘッダに追加されている	
[ ] ユーザーからのAPIリクエスト時に Authorization ヘッダが送信されている	
[ ] 内部処理からの呼び出し時には認証がバイパスされる	
[ ] トークン漏洩を防ぐためにアクセス権限が適切に設定されている	
