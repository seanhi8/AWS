# プロジェクト テスト仕様書（統合サーバーレスアーキテクチャ）

## 1. はじめに  
本仕様書は、AWS上に構築した統合サーバーレスアーキテクチャに対し、各種リソースの正常動作、通信経路の疎通、安全性を検証し、安定したサービス提供を目的として作成したものである。  
本環境は、**フロントエンド向けのパブリック配信環境**（CloudFront経由）と、**バックエンド向けの内部API環境**（API Gateway単独）を併存させた構成となっている。  

---

## 2. システム構成概要（統合アーキテクチャ図）

                               +---------------------+
                               |     End Users       |
                               | (Browser / Mobile)  |
                               +----------+----------+
                                          |
                                          v
                                 +------------------+
                                 |   CloudFront     |  ← Public CDN + TLS + caching
                                 +--------+---------+
                                          |
                                          v
                                 +------------------+
                                 |      WAF v2      |  ← Protects public traffic
                                 +--------+---------+
                                          |
                            +-------------+-------------+
                            |                           |
                   +--------v-------+           +-------v--------+
                   | Routing Logic  |           | Routing Logic  |
                   |  (Frontend)    |           |  (Backend)     |
                   +--------+-------+           +-------+--------+
                            |                           |
       +--------------------+---------------+           |
       |                                    |           |
+----------v---------+ +-----------v-------+ |
| S3 Static Bucket | | API Gateway | |
| (Private via OAI) | | (Frontend APIs) | |
+--------------------+ +-----------+-------+ |
| |
v |
+-------------+ |
| Lambda | |
| Dispatcher | |
+------+------+ |
| |
+------------------------+--------+ |
| | | |
+---v---+ +----v----+ +v---v---+
|DynamoDB| | S3 Data | | SES/SNS |
|(User )| | Bucket | | EventBr.|
+--------+ +---------+ +---------+


   (Frontend static content & API)               (Backend Internal APIs)
                                         
                                         
                                         
                         +-------------------------------------------+
                         |          Internal Users / Admin           |
                         +------------------+------------------------+
                                            |
                                            v
                                   +------------------+
                                   | API Gateway (Int) |  ← Internal API Gateway only
                                   +--------+---------+
                                            |
                                            v
                                   +------------------+
                                   |  Lambda          |  ← Backend Dispatcher
                                   +--------+---------+
                                            |
                            +---------------+----------------+
                            |               |                |
                        +---v---+       +---v----+       +---v---+
                        |DynamoDB|      |S3 Data |       | SES/SNS|
                        |(Data)  |      |Bucket  |       | EventB.|
                        +--------+      +--------+       +--------+

---

## 3. テスト対象範囲

| リソース                   | 内容・役割                                           |
|----------------------------|----------------------------------------------------|
| CloudFront                 | CDNとしての配信機能、ルーティング動作               |
| WAF v2                    | 攻撃防御ルールの適用・動作                           |
| S3 Static Bucket          | 静的ファイル（HTML, CSS, JS等）の安全かつ正常な配信 |
| API Gateway (Public)      | フロントエンドAPIのリクエスト受付                   |
| API Gateway (Internal)    | バックエンドAPIのリクエスト受付                       |
| Lambda (Dispatcher)       | API処理の正常実行                                    |
| DynamoDB                  | データ格納・検索処理の正確性                         |
| S3 Data Bucket            | ファイルアップロード／ダウンロード処理の正常性       |
| SES / SNS / EventBridge   | 通知・メッセージ送信、イベント処理                   |

---

## 4. テスト項目

### 4.1 可用性テスト
- CloudFront経由で静的ファイルアクセスが正常か
- WAFの適切なルール適用が確認できるか
- API Gateway（パブリック・内部）へのリクエストが正常応答するか
- Lambdaが正常に処理を完了できるか
- DynamoDBのデータ登録・検索が問題なく行えるか
- S3 Data Bucketのファイルアップロード・ダウンロードが正常か
- SES、SNS、EventBridge連携の動作が問題ないか

### 4.2 疎通テスト（ネットワーク・通信）
- CloudFrontからS3およびAPI Gatewayへの通信経路が正常か
- API GatewayからLambda、バックエンドリソースへのアクセスが可能か
- 内部API Gatewayのアクセス制限（IP制限等）が有効か
- LambdaからDynamoDB、S3、SES等への通信確認

### 4.3 セキュリティ・脆弱性テスト
- WAFによる攻撃遮断（SQLi、XSS、Bot Control等）が有効か
- API Gatewayの認証・認可設定が適切か（IAMロール、ポリシー）
- S3バケットポリシーでパブリックアクセスが完全に遮断されているか
- Lambda実行ロールの最小権限設定確認
- ログ監査（CloudTrail、CloudWatch Logs）によるアクセス記録の取得・分析

---

## 5. 具体的なテスト方法例

| テスト項目               | 具体的手順例                                                     | ツール・コマンド例                                 |
|-------------------------|------------------------------------------------------------------|-------------------------------------------------|
| CloudFront配信確認      | 1. ブラウザでトップページや静的リソース（例：/static/app.js）にアクセス<br>2. レスポンスヘッダーに`X-Cache: Hit from cloudfront`があるか確認 | ブラウザ開発者ツール、curlコマンド例：`curl -I https://example.com/static/app.js` |
| WAF遮断動作確認         | 1. SQLインジェクション疑似リクエストをAPIに送信（例：`' OR '1'='1`）<br>2. WAFがリクエストをブロックし、HTTP 403等のレスポンスが返るか確認 | OWASP ZAPのActive Scan、curlで悪意ある文字列送信 |
| API Gateway疎通テスト   | 1. PostmanでAPIの正常系リクエストを実行<br>2. レスポンスが期待通りのJSONかつHTTP 200であることを確認 | Postman、curl例：`curl -X GET https://api.example.com/v1/users` |
| Lambda正常動作確認      | 1. API Gateway経由でLambdaを呼び出し<br>2. CloudWatch Logsでエラーや例外が出ていないかを確認 | AWSコンソールのCloudWatch Logs、AWS CLIログ取得 |
| DynamoDB操作確認       | 1. API経由でデータ登録・取得を実施<br>2. DynamoDBコンソールで該当データの有無を確認 | AWS CLIコマンド例：`aws dynamodb get-item ...` |
| S3ファイル操作確認      | 1. Lambda経由でS3へファイルアップロード要求を送信<br>2. S3コンソールで対象ファイルが存在するか確認<br>3. ダウンロードも同様に確認 | AWS CLI例：`aws s3 cp s3://bucket/key .` |
| SESメール送信確認      | 1. Lambda経由でメール送信APIを呼び出し<br>2. 実際にメールが受信できるか確認 | メールクライアント、SES送信テストツール |
| API認可制御確認        | 1. 不正なIAM権限でAPIを呼び出しアクセス拒否されるか検証<br>2. 正しい権限では正常応答を確認 | AWS IAMポリシーテスト、Postmanで署名付リクエスト |

---

## 6. 合格判定基準

- すべてのAPIレスポンスはHTTPステータス200台で正常応答すること  
- WAFにより悪意のある攻撃リクエストが遮断されること  
- Lambda処理がタイムアウトなく正常完了すること  
- S3バケットのパブリックアクセスが完全に遮断されていること  
- 内部API Gatewayのアクセスが制限された範囲外からは拒否されること  
- 監査ログがCloudWatch/CloudTrailに確実に出力されていること  

| No.   | テスト項目                                   | テスト内容（手順）                                                                                                                                                 | 期待結果                                                                                                                                                         |
|-------|----------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 4.1.1 | CloudFront経由で静的ファイルアクセスが正常か | 1. ブラウザでCloudFrontドメインにアクセスし、トップページを表示<br>2. 開発者ツールでCSS、JS、画像ファイルのリクエストを確認<br>3. curlで静的ファイルにGETリクエスト送信 | - 全てHTTP 200 OKを返す<br>- ファイルサイズ・MD5が一致<br>- ブラウザで正しく表示される                                                                                      |
| 4.1.2 | WAFの適切なルール適用が確認できるか          | 1. SQLインジェクション疑似コードを含むリクエスト送信<br>2. XSS攻撃模擬リクエスト送信<br>3. ボットと見なされる大量連続リクエスト送信                               | - リクエストはWAFで遮断（HTTP 403）<br>- 正常リクエストは通過<br>- 攻撃検知ログがCloudWatch等に記録                                                                                  |
| 4.1.3 | API Gateway（パブリック・内部）へのリクエストが正常応答するか | 1. 公開APIに正しい認証情報でGET/POSTリクエスト<br>2. 許可IPから内部APIにアクセス<br>3. 誤った認証情報や未認証でアクセス試行                                  | - 正しい認証はHTTP 200で期待レスポンス返却<br>- 誤認証はHTTP 401/403で拒否<br>- 内部APIは許可IPからのみアクセス成功                                                                        |
| 4.1.4 | Lambdaが正常に処理を完了できるか             | 1. API Gateway経由でLambda呼び出し<br>2. CloudWatch Logsでエラー無し確認<br>3. DynamoDBの更新状況確認                                                             | - Lambdaが例外なく正常終了<br>- 「処理成功」ログがある<br>- DynamoDBに期待通りデータ反映                                                                                             |
| 4.1.5 | DynamoDBのデータ登録・検索が問題なく行えるか  | 1. PutItemでテストデータ登録<br>2. Query/Scanで登録データ取得<br>3. 複数条件・インデックス検索も検証                                                              | - PutItem成功しエラー無し<br>- Query結果が期待通り<br>- インデックス検索が正確かつ高速に動作                                                                                            |
| 4.1.6 | S3 Data Bucketのファイルアップロード・ダウンロードが正常か | 1. 許可ユーザーでファイルアップロード<br>2. S3コンソールでファイル存在確認<br>3. ファイルダウンロードして内容チェック<br>4. 認証なしでアクセス試行             | - アップロード・ダウンロード成功<br>- ファイル破損無し<br>- パブリックアクセス遮断                                                                                                  |
| 4.1.7 | SES、SNS、EventBridge連携の動作が問題ないか | 1. SESでテストメール送信し受信確認<br>2. SNSにメッセージ発行、サブスクライバーで受信確認<br>3. EventBridgeで指定イベント発生とLambdaトリガー確認              | - メール正常に届く<br>- SNS通知が届く<br>- EventBridgeが正しくトリガーされる                                                                                                         |
| 4.2.1 | CloudFrontからS3およびAPI Gatewayへの通信経路が正常か | 1. CloudFrontアクセスログでS3/API Gatewayへのリクエスト確認<br>2. CloudFront経由でファイル・API呼び出し実施                                                    | - アクセスログに正常なリクエスト記録あり<br>- レスポンスHTTP 200                                                                                                                     |
| 4.2.2 | API GatewayからLambda、バックエンドリソースへのアクセスが可能か | 1. API Gateway経由でLambda呼び出し<br>2. LambdaのCloudWatch LogsでDynamoDB/S3アクセス成功を確認                                                                 | - Lambdaがバックエンドリソースに正常アクセス<br>- エラー・タイムアウト無し                                                                                                           |
| 4.2.3 | 内部API Gatewayのアクセス制限（IP制限等）が有効か | 1. 許可IPからアクセス成功確認<br>2. 許可外IPからアクセス拒否確認                                                                                               | - 許可IPからHTTP 200成功<br>- 許可外IPはHTTP 403拒否                                                                                                                                |
| 4.2.4 | LambdaからDynamoDB、S3、SES等への通信確認     | 1. Lambda関数で各種リソース操作（PutItem、GetObject、SendEmail）を実行<br>2. CloudWatch Logsで成功ログ確認                                                       | - 各リソースへの通信成功<br>- エラー無し                                                                                                                                            |
| 4.3.1 | WAFによる攻撃遮断（SQLi、XSS、Bot Control等）が有効か | 1. SQLiペイロード送信<br>2. XSSスクリプト挿入リクエスト送信<br>3. ボット模倣アクセス多数送信                                                                     | - 全てWAFで遮断、HTTP 403応答<br>- WAFログに検知記録あり                                                                                                                            |
| 4.3.2 | API Gatewayの認証・認可設定が適切か（IAMロール、ポリシー） | 1. 未認証リクエスト拒否確認<br>2. 適切認証付きアクセス成功確認<br>3. 権限不足ユーザーの拒否確認                                                                  | - 未認証・権限不足は拒否<br>- 適切認証ユーザーのみ成功                                                                                                                               |
| 4.3.3 | S3バケットポリシーでパブリックアクセスが完全に遮断されているか | 1. S3バケットのパブリックアクセス設定確認<br>2. 認証なしユーザーのGetObject試行で拒否確認                                                                         | - パブリックアクセスは全て拒否                                                                                                                       |
| 4.3.4 | Lambda実行ロールの最小権限設定確認             | 1. Lambda実行ロールのポリシードキュメントレビュー                                                                                                               | - 必要最小限の権限のみ付与<br>- ワイルドカード無し                                                                                                                                  |
| 4.3.5 | ログ監査（CloudTrail、CloudWatch Logs）によるアクセス記録の取得・分析 | 1. CloudTrailログに重要APIコール記録あり確認<br>2. CloudWatch LogsにLambda/WAF/API Gatewayログがあること確認<br>3. ログから不審アクセス抽出・解析                   | - すべてのログが漏れなく収集<br>- 不正アクセス検知可能                                                                                                                               |
