# プロジェクト テスト仕様書（統合サーバーレスアーキテクチャ）

## 1. はじめに  
本仕様書は、AWS上に構築した統合サーバーレスアーキテクチャに対し、各種リソースの正常動作、通信経路の疎通、安全性を検証し、安定したサービス提供を目的として作成したものである。  
本環境は、**フロントエンド向けのパブリック配信環境**（CloudFront経由）と、**バックエンド向けの内部API環境**（API Gateway単独）を併存させた構成となっている。  

---

## 2. システム構成概要（統合アーキテクチャ図）

                               +---------------------+
                               |     End Users       |
                               | (Browser / Mobile)  |
                               +----------+----------+
                                          |
                                          v
                                 +------------------+
                                 |   CloudFront     |  ← Public CDN + TLS + caching
                                 +--------+---------+
                                          |
                                          v
                                 +------------------+
                                 |      WAF v2      |  ← Protects public traffic
                                 +--------+---------+
                                          |
                            +-------------+-------------+
                            |                           |
                   +--------v-------+           +-------v--------+
                   | Routing Logic  |           | Routing Logic  |
                   |  (Frontend)    |           |  (Backend)     |
                   +--------+-------+           +-------+--------+
                            |                           |
       +--------------------+---------------+           |
       |                                    |           |
+----------v---------+ +-----------v-------+ |
| S3 Static Bucket | | API Gateway | |
| (Private via OAI) | | (Frontend APIs) | |
+--------------------+ +-----------+-------+ |
| |
v |
+-------------+ |
| Lambda | |
| Dispatcher | |
+------+------+ |
| |
+------------------------+--------+ |
| | | |
+---v---+ +----v----+ +v---v---+
|DynamoDB| | S3 Data | | SES/SNS |
|(User )| | Bucket | | EventBr.|
+--------+ +---------+ +---------+


   (Frontend static content & API)               (Backend Internal APIs)
                                         
                                         
                                         
                         +-------------------------------------------+
                         |          Internal Users / Admin           |
                         +------------------+------------------------+
                                            |
                                            v
                                   +------------------+
                                   | API Gateway (Int) |  ← Internal API Gateway only
                                   +--------+---------+
                                            |
                                            v
                                   +------------------+
                                   |  Lambda          |  ← Backend Dispatcher
                                   +--------+---------+
                                            |
                            +---------------+----------------+
                            |               |                |
                        +---v---+       +---v----+       +---v---+
                        |DynamoDB|      |S3 Data |       | SES/SNS|
                        |(Data)  |      |Bucket  |       | EventB.|
                        +--------+      +--------+       +--------+

---

## 3. テスト対象範囲

| リソース                   | 内容・役割                                           |
|----------------------------|----------------------------------------------------|
| CloudFront                 | CDNとしての配信機能、ルーティング動作               |
| WAF v2                    | 攻撃防御ルールの適用・動作                           |
| S3 Static Bucket          | 静的ファイル（HTML, CSS, JS等）の安全かつ正常な配信 |
| API Gateway (Public)      | フロントエンドAPIのリクエスト受付                   |
| API Gateway (Internal)    | バックエンドAPIのリクエスト受付                       |
| Lambda (Dispatcher)       | API処理の正常実行                                    |
| DynamoDB                  | データ格納・検索処理の正確性                         |
| S3 Data Bucket            | ファイルアップロード／ダウンロード処理の正常性       |
| SES / SNS / EventBridge   | 通知・メッセージ送信、イベント処理                   |

---

## 4. テスト項目

### 4.1 可用性テスト
- CloudFront経由で静的ファイルアクセスが正常か
- WAFの適切なルール適用が確認できるか
- API Gateway（パブリック・内部）へのリクエストが正常応答するか
- Lambdaが正常に処理を完了できるか
- DynamoDBのデータ登録・検索が問題なく行えるか
- S3 Data Bucketのファイルアップロード・ダウンロードが正常か
- SES、SNS、EventBridge連携の動作が問題ないか

### 4.2 疎通テスト（ネットワーク・通信）
- CloudFrontからS3およびAPI Gatewayへの通信経路が正常か
- API GatewayからLambda、バックエンドリソースへのアクセスが可能か
- 内部API Gatewayのアクセス制限（IP制限等）が有効か
- LambdaからDynamoDB、S3、SES等への通信確認

### 4.3 セキュリティ・脆弱性テスト
- WAFによる攻撃遮断（SQLi、XSS、Bot Control等）が有効か
- API Gatewayの認証・認可設定が適切か（IAMロール、ポリシー）
- S3バケットポリシーでパブリックアクセスが完全に遮断されているか
- Lambda実行ロールの最小権限設定確認
- ログ監査（CloudTrail、CloudWatch Logs）によるアクセス記録の取得・分析

---

## 5. 具体的なテスト方法例

| テスト項目               | 具体的手順例                                                     | ツール・コマンド例                                 |
|-------------------------|------------------------------------------------------------------|-------------------------------------------------|
| CloudFront配信確認      | 1. ブラウザでトップページや静的リソース（例：/static/app.js）にアクセス<br>2. レスポンスヘッダーに`X-Cache: Hit from cloudfront`があるか確認 | ブラウザ開発者ツール、curlコマンド例：`curl -I https://example.com/static/app.js` |
| WAF遮断動作確認         | 1. SQLインジェクション疑似リクエストをAPIに送信（例：`' OR '1'='1`）<br>2. WAFがリクエストをブロックし、HTTP 403等のレスポンスが返るか確認 | OWASP ZAPのActive Scan、curlで悪意ある文字列送信 |
| API Gateway疎通テスト   | 1. PostmanでAPIの正常系リクエストを実行<br>2. レスポンスが期待通りのJSONかつHTTP 200であることを確認 | Postman、curl例：`curl -X GET https://api.example.com/v1/users` |
| Lambda正常動作確認      | 1. API Gateway経由でLambdaを呼び出し<br>2. CloudWatch Logsでエラーや例外が出ていないかを確認 | AWSコンソールのCloudWatch Logs、AWS CLIログ取得 |
| DynamoDB操作確認       | 1. API経由でデータ登録・取得を実施<br>2. DynamoDBコンソールで該当データの有無を確認 | AWS CLIコマンド例：`aws dynamodb get-item ...` |
| S3ファイル操作確認      | 1. Lambda経由でS3へファイルアップロード要求を送信<br>2. S3コンソールで対象ファイルが存在するか確認<br>3. ダウンロードも同様に確認 | AWS CLI例：`aws s3 cp s3://bucket/key .` |
| SESメール送信確認      | 1. Lambda経由でメール送信APIを呼び出し<br>2. 実際にメールが受信できるか確認 | メールクライアント、SES送信テストツール |
| API認可制御確認        | 1. 不正なIAM権限でAPIを呼び出しアクセス拒否されるか検証<br>2. 正しい権限では正常応答を確認 | AWS IAMポリシーテスト、Postmanで署名付リクエスト |

---

## 6. 合格判定基準

- すべてのAPIレスポンスはHTTPステータス200台で正常応答すること  
- WAFにより悪意のある攻撃リクエストが遮断されること  
- Lambda処理がタイムアウトなく正常完了すること  
- S3バケットのパブリックアクセスが完全に遮断されていること  
- 内部API Gatewayのアクセスが制限された範囲外からは拒否されること  
- 監査ログがCloudWatch/CloudTrailに確実に出力されていること  


                                   +---------------------+
                                   |     End Users       |
                                   | (Browser / Mobile)  |
                                   +----------+----------+
                                              |
                                              v
                                     +------------------+
                                     |   CloudFront     |  ← Public CDN + TLS + caching
                                     +--------+---------+
                                              |
                                              v
                                     +------------------+
                                     |      WAF v2      |  ← Protects public traffic
                                     +--------+---------+
                                              |
                                +-------------+-------------+
                                |                           |
                       +--------v-------+           +-------v--------+
                       | Routing Logic  |           | Routing Logic  |
                       |  (Frontend)    |           |  (Backend)     |
                       +--------+-------+           +-------+--------+
                                |                           |
           +--------------------+---------------+           |
           |                                    |           |
+----------v---------+              +-----------v-------+   |
|   S3 Static Bucket |              |  API Gateway      |   |
| (Private via OAI)  |              | (Frontend APIs)   |   |
+--------------------+              +-----------+-------+   |
                                             |              |
                                             v              |
                                       +-------------+      |
                                       |  Lambda     |      |
                                       | Dispatcher  |      |
                                       +------+------+      |
                                              |             |
                     +------------------------+--------+    |
                     |                        |        |    |
                 +---v---+               +----v----+  +v----v----+
                 |DynamoDB|               | S3 Data |  | SES/SNS |
                 |(User  )|               | Bucket  |  | EventBr.|
                 +--------+               +---------+  +---------+
 
       (Frontend static content & API)               (Backend Internal APIs)
                                             
                                             
                                             
                             +-------------------------------------------+
                             |          Internal Users / Admin           |
                             +------------------+------------------------+
                                                |
                                                v
                                       +------------------+
                                       | API Gateway (Int) |  ← Internal API Gateway only
                                       +--------+---------+
                                                |
                                                v
                                       +------------------+
                                       |  Lambda          |  ← Backend Dispatcher
                                       +--------+---------+
                                                |
                                +---------------+----------------+
                                |               |                |
                            +---v---+       +---v----+       +---v---+
                            |DynamoDB|      |S3 Data |       | SES/SNS|
                            |(Data)  |      |Bucket  |       | EventB.|
                            +--------+      +--------+       +--------+

